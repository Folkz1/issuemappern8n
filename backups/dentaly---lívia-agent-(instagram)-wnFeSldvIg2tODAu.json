{"updatedAt":"2026-01-15T23:19:52.060Z","createdAt":"2026-01-15T16:14:26.594Z","id":"wnFeSldvIg2tODAu","name":"Dentaly - LÃ­via Agent (Instagram)","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"17841479774657796","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2080,0],"id":"61f25f25-7333-4bef-ac72-ee6b7d2a285b","name":"Messenger Trigger","webhookId":"a7735139-15ae-4bee-ab65-d9d3d6e8c8be"},{"parameters":{"assignments":{"assignments":[{"id":"fe3f9231-7606-4073-91e4-898bf3922a76","name":"tipo_mensagem","value":"={{ $json.body.entry?.[0]?.messaging?.[0]?.message?.text ? 'text' : ($json.body.entry?.[0]?.messaging?.[0]?.message?.attachments?.[0]?.type || 'unknown') }}","type":"string"},{"id":"9da1fcfc-e5ea-4433-9933-595b24f0ba42","name":"numero_conversa","value":"={{ $json.body.entry?.[0]?.messaging?.[0]?.sender?.id || '' }}","type":"string"},{"id":"ebaa7566-ec95-46f0-87ec-ba1adac53613","name":"nome_cliente","value":"={{ '' }}","type":"string"},{"id":"a8d6f721-a227-45b0-92e7-b7848a3b9185","name":"Timestamp","value":"={{ new Date(($json.body.entry?.[0]?.messaging?.[0]?.timestamp || Date.now())).toISOString() }}","type":"string"},{"id":"b59136d5-cb83-4472-8649-d859c68844a6","name":"conteudo_mensagem_text","value":"={{ $json.body.entry?.[0]?.messaging?.[0]?.message?.text || '' }}","type":"string"},{"id":"c69fba37-a5aa-4904-8f7f-dd24372d6524","name":"is_echo","value":"={{ $json.body.entry?.[0]?.messaging?.[0]?.message?.is_echo === true }}","type":"boolean"},{"id":"2531bbcd-fb58-47bb-bfb6-b218c34832fc","name":"has_attachments","value":"={{ !!$json.body.entry?.[0]?.messaging?.[0]?.message?.attachments?.length }}","type":"boolean"},{"id":"0a7c0d55-a3d8-478c-b760-9a5a857b8c07","name":"should_process","value":"={{ !!$json.body.entry?.[0]?.messaging?.[0]?.message && $json.body.entry?.[0]?.messaging?.[0]?.message?.is_echo !== true }}","type":"boolean"},{"id":"1ea27905-eaf1-41b3-b598-eb2f9cf66f61","name":"should_process_text","value":"={{ !!$json.body.entry?.[0]?.messaging?.[0]?.message?.text }}","type":"boolean"},{"id":"3ed47908-a803-4656-89d7-acaddfb8fd63","name":"page_id","value":"={{ $json.body.metadata?.channel_identifier || $json.body.entry?.[0]?.id || '' }}","type":"string"},{"id":"f5b6f612-8025-479b-b49b-78741efbb87d","name":"project_id","value":"={{ $json.body.metadata?.project_id || '' }}","type":"string"},{"id":"94777bac-550b-43dd-96f3-83e3f25229a2","name":"access_token","value":"={{ $json.body.metadata?.access_token || '' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1856,0],"id":"d85b611e-538d-484e-a921-30e5b768d25b","name":"dados principais"},{"parameters":{"operation":"executeQuery","query":"WITH project AS (\n  SELECT\n    openrouter_api_key,\n    elevenlabs_api_key,\n    gemini_api_key,\n    nextcloud_base_url,\n    nextcloud_username,\n    nextcloud_password,\n    nextcloud_media_root\n  FROM public.project_secrets\n  WHERE project_id = NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid\n  LIMIT 1\n),\n global AS (\n  SELECT\n    openrouter_api_key,\n    elevenlabs_api_key,\n    nextcloud_base_url,\n    nextcloud_username,\n    nextcloud_password\n  FROM public.global_secrets\n  ORDER BY created_at DESC\n  LIMIT 1\n)\nSELECT\n  COALESCE(project.openrouter_api_key, global.openrouter_api_key) AS openrouter_api_key,\n  COALESCE(project.elevenlabs_api_key, global.elevenlabs_api_key) AS elevenlabs_api_key,\n  project.gemini_api_key AS gemini_api_key,\n  COALESCE(project.nextcloud_base_url, global.nextcloud_base_url) AS nextcloud_base_url,\n  COALESCE(project.nextcloud_username, global.nextcloud_username) AS nextcloud_username,\n  COALESCE(project.nextcloud_password, global.nextcloud_password) AS nextcloud_password,\n  COALESCE(project.nextcloud_media_root, 'SuperBotMedia') AS nextcloud_media_root\nFROM (SELECT 1) AS base\nLEFT JOIN project ON true\nLEFT JOIN global ON true;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1632,96],"id":"47b606b7-177c-4a69-89e5-30edb08aeeed","name":"Fetch Project Secrets","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO public.conversation_events (\n  project_id,\n  channel_identifier,\n  channel_type,\n  conversation_id,\n  direction,\n  message_type,\n  text,\n  raw_payload,\n  metadata\n)\nVALUES (\n  NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid,\n  '{{ $('dados principais').item.json.page_id }}',\n  'instagram',\n  '{{ $('dados principais').item.json.numero_conversa }}',\n  'in',\n  '{{ $('dados principais').item.json.tipo_mensagem }}',\n  '{{ ($('dados principais').item.json.conteudo_mensagem_text || '').replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($('Messenger Trigger').item.json.body, (k, v) => (k === 'access_token' || k === 'openrouter_api_key' || k === 'elevenlabs_api_key' || k === 'nextcloud_password' || k === 'meta_master_token' || k === 'gemini_api_key') ? undefined : v).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ JSON.stringify({ timestamp: $('dados principais').item.json.Timestamp, is_echo: $('dados principais').item.json.is_echo, has_attachments: $('dados principais').item.json.has_attachments }).replace(/'/g, \"''\") }}'::jsonb\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1632,-96],"id":"aa050d84-5e14-41f1-afdb-b84ead0ee359","name":"Log Inbound Event (Postgres)","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7f508402-93a3-4c26-bf39-ecd52613bcef","leftValue":"={{ $('dados principais').first().json.should_process }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1408,96],"id":"7ef5e9ff-a90e-40dc-81b7-4a41aab67dfa","name":"Processar mensagem?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"520dad43-1dc3-49ce-8869-36775e5818d3","leftValue":"={{ $('dados principais').item.json.should_process_text }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-288,96],"id":"191440ad-d01b-42a4-bf5c-e5656fd119b6","name":"Tem texto?"},{"parameters":{"conditions":{"string":[{"value1":"={{ $('dados principais').item.json.conteudo_mensagem_text }}","operation":"contains","value2":"#delete"}]}},"type":"n8n-nodes-base.if","typeVersion":1,"position":[-1184,96],"id":"36c25dae-44e4-446e-926a-1bbada1b59ac","name":"Check #delete Command"},{"parameters":{"jsCode":"  const axios = require('axios');\n\n  const recipientId = $('dados principais').first().json.numero_conversa;\n  const token = $('dados principais').first().json.access_token;    \n\n  const messageText = 'âœ… Seus dados foram resetados com sucesso!\\n\\nVocÃª pode comeÃ§ar uma nova conversa do zero. Como posso te ajudar?';\n  // Usar me/messages (igual aos outros cÃ³digos que funcionam)      \n  const url = `https://graph.facebook.com/v21.0/me/messages`;       \n\n  const data = {\n    recipient: { id: recipientId },\n    message: { text: messageText }\n  };\n\n  try {\n    const resp = await axios.post(url, data, {\n      headers: {\n        Authorization: `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      },\n      timeout: 60000,\n    });\n\n    return {\n      json: {\n        success: true,\n        reset_complete: true,\n        sent: { text: messageText },\n        result: resp.data\n      }\n    };\n  } catch (error) {\n    return {\n      json: {\n        success: false,\n        error: error.response ? error.response.data : error.message,        errorStatus: error.response?.status,\n        errorDetails: error.response?.data?.error\n      }\n    };\n  }"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-512,-80],"id":"aa8bea23-2b70-4b48-ae51-d54436569df7","name":"Send Reset Confirmation"},{"parameters":{"operation":"executeQuery","query":"-- Gerenciar usuÃ¡rio multi-tenant com preservaÃ§Ã£o de metadados\nINSERT INTO public.users (\n  id, \n  project_id,\n  name, \n  metadata, \n  created_at, \n  updated_at\n)\nVALUES (\n  '{{ $('dados principais').item.json.numero_conversa }}',\n  NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid,\n  '{{ $('dados principais').item.json.nome_cliente }}',\n  '{}'::jsonb,\n  NOW(),\n  NOW()\n)\nON CONFLICT (id, project_id) DO UPDATE SET\n  name = EXCLUDED.name,\n  updated_at = NOW()\nRETURNING *;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-960,192],"id":"99880874-9b6d-44d8-9e3f-d1936cc581eb","name":"Gerenciar Usuario (Postgres)","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"caAnMvnvVXE0mLvT","mode":"list","cachedResultUrl":"/workflow/caAnMvnvVXE0mLvT","cachedResultName":"Agente Livia"},"workflowInputs":{"mappingMode":"defineBelow","value":{"numero_conversa":"={{ $('dados principais').item.json.numero_conversa }}","final_user_message":"={{ $json.final_user_message }}","numero_conversa_firstItem":"={{ $('dados principais').first().json.numero_conversa }}","client_context":"={{ 'â“ [CLIENTE NÃƒO IDENTIFICADO VIA INSTAGRAM]\\nStatus: needs_cpf\\nInstruÃ§Ã£o: Tente solicitar o CPF para busca mais precisa.\\n' }}","birthday_alert":"={{ '' }}","customer_name_split":"={{ '' }}","id":"={{ $('Gerenciar Usuario (Postgres)').item.json.id }}","project_id":"={{ $('Gerenciar Usuario (Postgres)').item.json.project_id }}","channel_type":"={{ 'instagram' }}"},"matchingColumns":["numero_conversa","final_user_message","numero_conversa_firstItem","client_context","birthday_alert","customer_name_split","id","project_id","channel_type"],"schema":[{"id":"numero_conversa","displayName":"numero_conversa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"final_user_message","displayName":"final_user_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"numero_conversa_firstItem","displayName":"numero_conversa_firstItem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"client_context","displayName":"client_context","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"birthday_alert","displayName":"birthday_alert","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"customer_name_split","displayName":"customer_name_split","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"id","displayName":"id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"project_id","displayName":"project_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"channel_type","displayName":"channel_type","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[160,192],"id":"71b6c330-7c5b-4604-9883-12c0f6ba6484","name":"Call Livia apenas o agente"},{"parameters":{"jsCode":"const input = $input.first().json.output || '';\nconst output = input.replace(/\\*\\*(.*?)\\*\\*/g, '*$1*');\nreturn [{ json: { result: output } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[384,192],"id":"53dced79-03e1-4f7d-b813-7d11b7b1f9d3","name":"Tratar resposta"},{"parameters":{"assignments":{"assignments":[{"id":"bb70c647-df05-4b35-ba0d-be8ff4ba4335","name":"messages","value":"={{ ($json.result || '').split(\"\\n\\n\").filter(m => m.trim() !== '') }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[608,192],"id":"cf404649-37b1-4ced-82f4-67eee1577dbd","name":"Reposta da orquestra"},{"parameters":{"fieldToSplitOut":"messages","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[832,192],"id":"a24e43d0-e81a-4004-a8c1-ce7242e33e1a","name":"Split Out1"},{"parameters":{"jsCode":"  const axios = require('axios');\n\n  const recipientId = $('dados principais').first().json.numero_conversa;\n  const token = $('dados principais').first().json.access_token;    \n\n  let messageBody = ($json.messages || '').toString().trim();       \n  if (!messageBody) return { json: { success: true, skipped: true } \n};\n\n  // Extrair URL do Markdown: ![alt](url)\n  const markdownMatch = messageBody.match(/!\\[.*?\\]\\((.*?)\\)/);     \n  if (markdownMatch) messageBody = markdownMatch[1];\n\n  // Detectar tipo de mÃ­dia\n  let attachmentType = null;\n  let cleanUrl = messageBody;\n\n  const mediaUrlMatch = messageBody.match(/(https?:\\/\\/[^\\s]+#(?:image|video|audio))/i);\n  if (mediaUrlMatch) {\n    const full = mediaUrlMatch[1];\n    if (full.includes('#image')) {\n      attachmentType = 'image';\n      cleanUrl = full.replace(/#image/gi, '').trim();\n    } else if (full.includes('#video')) {\n      attachmentType = 'video';\n      cleanUrl = full.replace(/#video/gi, '').trim();\n    } else if (full.includes('#audio')) {\n      attachmentType = 'audio';\n      cleanUrl = full.replace(/#audio/gi, '').trim();\n    }\n  } else if (messageBody.includes('#image')) {\n    attachmentType = 'image';\n    cleanUrl = messageBody.replace(/#image/gi, '').trim();\n  }\n\n  const url = `https://graph.facebook.com/v21.0/me/messages`;       \n  const headers = {\n    Authorization: `Bearer ${token}`,\n    'Content-Type': 'application/json'\n  };\n\n  // ===== ENVIO DE IMAGEM POR URL =====\n  if (attachmentType === 'image' && cleanUrl) {\n    try {\n      const resp = await axios.post(\n        url,\n        {\n          recipient: { id: recipientId },\n          message: {\n            attachment: {\n              type: 'image',\n              payload: {\n                url: cleanUrl,\n                is_reusable: true\n              }\n            }\n          }\n        },\n        { headers, timeout: 60000 }\n      );\n\n      return {\n        json: {\n          success: true,\n          attachmentType: 'image',\n          sent: { type: 'image', url: cleanUrl },\n          result: resp.data,\n        }\n      };\n    } catch (e) {\n      // Fallback: envia como texto se der erro\n      try {\n        const fallbackResp = await axios.post(\n          url,\n          {\n            recipient: { id: recipientId },\n            message: { text: cleanUrl }\n          },\n          { headers, timeout: 60000 }\n        );\n\n        return {\n          json: {\n            success: false,\n            attachmentType: 'image',\n            fallback: true,\n            error: e?.response?.data || e.message,\n            sent: { text: cleanUrl },\n            result: fallbackResp.data,\n          }\n        };\n      } catch (fallbackError) {\n        return {\n          json: {\n            success: false,\n            attachmentType: 'image',\n            error: e?.response?.data || e.message,\n            fallbackError: fallbackError?.response?.data || fallbackError.message,\n            errorStatus: e?.response?.status,\n          }\n        };\n      }\n    }\n  }\n\n  // ===== ENVIO DE VÃDEO POR URL =====\n  if (attachmentType === 'video' && cleanUrl) {\n    try {\n      const resp = await axios.post(\n        url,\n        {\n          recipient: { id: recipientId },\n          message: {\n            attachment: {\n              type: 'video',\n              payload: {\n                url: cleanUrl,\n                is_reusable: true\n              }\n            }\n          }\n        },\n        { headers, timeout: 60000 }\n      );\n\n      return {\n        json: {\n          success: true,\n          attachmentType: 'video',\n          sent: { type: 'video', url: cleanUrl },\n          result: resp.data,\n        }\n      };\n    } catch (e) {\n      const fallbackResp = await axios.post(\n        url,\n        { recipient: { id: recipientId }, message: { text: cleanUrl \n} },\n        { headers, timeout: 60000 }\n      );\n\n      return {\n        json: {\n          success: false,\n          attachmentType: 'video',\n          fallback: true,\n          error: e?.response?.data || e.message,\n          sent: { text: cleanUrl },\n          result: fallbackResp.data,\n        }\n      };\n    }\n  }\n\n  // ===== ENVIO DE TEXTO =====\n  try {\n    const resp = await axios.post(\n      url,\n      {\n        recipient: { id: recipientId },\n        message: { text: messageBody }\n      },\n      { headers, timeout: 60000 }\n    );\n\n    return {\n      json: {\n        success: true,\n        attachmentType: 'text',\n        sent: { text: messageBody },\n        result: resp.data,\n      }\n    };\n  } catch (e) {\n    return {\n      json: {\n        success: false,\n        attachmentType: 'text',\n        error: e?.response?.data || e.message,\n        errorStatus: e?.response?.status,\n        errorDetails: e?.response?.data?.error\n      }\n    };\n  }"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1280,192],"id":"089393b8-fd75-4a6f-a123-30820ce579bc","name":"Enviar mensagem (Messenger)"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO public.conversation_events (\n  project_id,\n  channel_identifier,\n  channel_type,\n  conversation_id,\n  direction,\n  message_type,\n  text,\n  media,\n  raw_payload\n)\nVALUES (\n  NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid,\n  '{{ $('dados principais').item.json.page_id }}',\n  'instagram',\n  '{{ $('dados principais').item.json.numero_conversa }}',\n  'out',\n  '{{ $json.attachmentType || 'text' }}',\n  '{{ (($json.sent && $json.sent.text) ? $json.sent.text : '').replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($json.sent || {}).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ JSON.stringify($json, (k, v) => (k === 'access_token' || k === 'openrouter_api_key' || k === 'elevenlabs_api_key' || k === 'nextcloud_password' || k === 'meta_master_token' || k === 'gemini_api_key') ? undefined : v).replace(/'/g, \"''\") }}'::jsonb\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1504,144],"id":"154c97ab-67d9-43b9-b08a-c984e426f300","name":"Log Outbound Event (Postgres)","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"jsCode":"const axios = require('axios');\n\nconst recipientId = $('dados principais').first().json.numero_conversa;\nconst igId = $('dados principais').first().json.page_id || $('dados principais').first().json.channel_identifier || '';\nconst token = $('dados principais').first().json.access_token;\n\nconst messageText = 'N?o consegui processar essa mensagem no Instagram. Pode me dizer em texto como posso te ajudar?';\n\nif (!igId) {\n  return { json: { success: false, error: 'Missing Instagram id (dados principais.page_id)' } };\n}\n\nconst url = `https://graph.facebook.com/v21.0/${igId}/messages`;\n\ntry {\n  const resp = await axios.post(\n    url,\n    { recipient: { id: recipientId }, message: { text: messageText } },\n    { headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' }, timeout: 60000 }\n  );\n\n  return { json: { success: true, sent: { text: messageText }, result: resp.data } };\n} catch (error) {\n  return { json: { success: false, error: error.response ? error.response.data : error.message } };\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,208],"id":"1774e27d-acb4-42a8-b4c7-99134bcff372","name":"Responder apenas texto (Messenger)"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1056,192],"id":"9cf632e3-5100-4ed7-a743-048bf8f682b6","name":"Loop Over Items"},{"parameters":{"amount":1},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1504,368],"id":"5b68afef-6a41-45db-98ef-388571297aa9","name":"Wait","webhookId":"8b20e43c-d380-4615-a9a3-5de5015dcf0b"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1280,0],"id":"25474d05-6c49-4185-a1d9-9e62264729e4","name":"No Operation, do nothing"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('dados principais').item.json.project_id + ':instagram:' + $('dados principais').item.json.numero_conversa }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-960,-80],"id":"a8f99a98-d8a1-4540-bc48-1570e5403e13","name":"reset-user-n8n_chat_histories","alwaysOutputData":true,"credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"users","mode":"list","cachedResultName":"users"},"deleteCommand":"delete","where":{"values":[{"column":"id","value":"={{ $('dados principais').item.json.numero_conversa }}"},{"column":"project_id","value":"={{ $('dados principais').item.json.project_id }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-736,-80],"id":"b8422f26-0e2f-46b8-a216-9c5ad6e5c857","name":"Reset User Data (SQL)","alwaysOutputData":true,"credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"has_attachments_condition","leftValue":"={{ $('dados principais').item.json.has_attachments }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-736,192],"id":"293ce9a2-5827-4743-8fa1-9b6f752195b9","name":"Tem anexos?"},{"parameters":{"jsCode":"const attachments = $('Messenger Trigger').item.json.body.entry?.[0]?.messaging?.[0]?.message?.attachments || [];\nconst messageText = ($('dados principais').item.json.conteudo_mensagem_text || '').toString();\n\nif (!attachments.length) {\n  return [{ json: { attachment_index: 0, attachment_type: 'unknown', attachment_url: '', message_text: messageText } }];\n}\n\nreturn attachments.map((att, idx) => ({\n  json: {\n    attachment_index: idx,\n    attachment_type: att?.type || 'file',\n    attachment_url: att?.payload?.url || '',\n    message_text: messageText,\n    attachment: att,\n  }\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-544,320],"id":"efd55fc2-e1a3-4bc2-9d55-b6f340d03861","name":"Prepare Attachments Items"},{"parameters":{"jsCode":"/**\n * n8n Code node (Node.js)\n * - Baixa anexo (imagem/Ã¡udio/vÃ­deo/etc) com token da Meta se houver\n * - Salva no Nextcloud via WebDAV\n * - Cria share link (download)\n * - Se for Ã¡udio: transcreve IGUAL aos nodes (OpenRouter + google/gemini-2.5-flash-lite usando \"image_url\" data:audio/*;base64)\n */\n\nconst axios = require('axios');\nconst fs = require('fs');\n\nfunction encodePath(p) {\n  return p.split('/').map(encodeURIComponent).join('/');\n}\n\nasync function ensureDavFolders(davBaseUrl, folderPath, auth) {\n  const parts = folderPath.split('/').filter(Boolean);\n  let current = '';\n\n  for (const part of parts) {\n    current = current ? `${current}/${part}` : part;\n    const url = `${davBaseUrl}/${encodePath(current)}`;\n\n    try {\n      await axios.request({ method: 'MKCOL', url, auth, timeout: 120000 });\n    } catch (error) {\n      const status = error?.response?.status;\n      // 405: jÃ¡ existe; 301/302: redirect; 409: parent missing (pode acontecer em alguns davs)\n      if (status === 405 || status === 301 || status === 302 || status === 409) continue;\n      throw error;\n    }\n  }\n}\n\nfunction formEncode(obj) {\n  return Object.entries(obj)\n    .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(String(v))}`)\n    .join('&');\n}\n\nfunction inferExt(mimeType, url) {\n  const mt = (mimeType || '').toLowerCase();\n  if (mt.includes('jpeg')) return 'jpg';\n  if (mt.includes('png')) return 'png';\n  if (mt.includes('webp')) return 'webp';\n  if (mt.includes('gif')) return 'gif';\n  if (mt.includes('mp4')) return 'mp4';\n  if (mt.includes('mpeg')) return 'mp3';\n  if (mt.includes('mp3')) return 'mp3';\n  if (mt.includes('wav')) return 'wav';\n  if (mt.includes('ogg')) return 'ogg';\n  if (mt.includes('pdf')) return 'pdf';\n\n  try {\n    const clean = String(url || '').split('?')[0].split('#')[0];\n    const last = clean.split('/').pop() || '';\n    if (last.includes('.')) {\n      const ext = last.split('.').pop();\n      if (ext && ext.length <= 6) return ext.toLowerCase().replace(/[^a-z0-9]/g, '');\n    }\n  } catch (_) {}\n\n  return 'bin';\n}\n\nfunction suffixFor(type, ext, mimeType) {\n  const t = (type || '').toLowerCase();\n  const mt = (mimeType || '').toLowerCase();\n  if (t === 'audio') return '#audio';\n  if (t === 'image') return '#image';\n  if (t === 'video') return '#video';\n  if (t === 'file' && (ext || '').toLowerCase() === 'pdf') return '#pdf';\n  if (mt.startsWith('audio/')) return '#audio';\n  if (mt.startsWith('image/')) return '#image';\n  if (mt.startsWith('video/')) return '#video';\n  return '#document';\n}\n\nasync function downloadAttachment(url, pageToken) {\n  const attempt = async (headers) => {\n    const resp = await axios.get(url, {\n      responseType: 'arraybuffer',\n      headers,\n      timeout: 120000,\n      maxBodyLength: Infinity,\n      maxContentLength: Infinity,\n      validateStatus: () => true,\n      maxRedirects: 5,\n    });\n    return resp;\n  };\n\n  let resp = await attempt(pageToken ? { Authorization: `Bearer ${pageToken}` } : undefined);\n  if (resp.status < 200 || resp.status >= 300) resp = await attempt(undefined);\n\n  if (resp.status < 200 || resp.status >= 300) {\n    return { ok: false, status: resp.status, data: resp.data };\n  }\n\n  return {\n    ok: true,\n    status: resp.status,\n    buffer: Buffer.from(resp.data),\n    mimeType: resp.headers?.['content-type'] || '',\n  };\n}\n\n// === TranscriÃ§Ã£o igual aos seus nodes (OpenRouter + Gemini flash lite usando \"image_url\" com data:audio/*;base64) ===\nasync function transcribeOpenRouterLikeNodes(openrouterKey, fileBuffer, mimeType) {\n  const b64 = fileBuffer.toString('base64');\n\n  // No seu node vocÃª usa data:audio/mp3;base64, ...\n  // Aqui a gente usa o mime real quando for Ã¡udio, senÃ£o cai em audio/mpeg\n  const safeMime = (mimeType && mimeType.toLowerCase().startsWith('audio/')) ? mimeType : 'audio/mpeg';\n\n  const resp = await axios.post(\n    'https://openrouter.ai/api/v1/chat/completions',\n    {\n      model: 'google/gemini-2.5-flash-lite',\n      messages: [\n        {\n          role: 'user',\n          content: [\n            { type: 'text', text: 'faÃ§a a trancriÃ§Ã£o exata do audio.' },\n            {\n              type: 'image_url',\n              image_url: {\n                url: `data:${safeMime};base64,${b64}`,\n              },\n            },\n          ],\n        },\n      ],\n    },\n    {\n      headers: {\n        Authorization: `Bearer ${openrouterKey}`,\n        'Content-Type': 'application/json',\n      },\n      timeout: 180000,\n      maxBodyLength: Infinity,\n      maxContentLength: Infinity,\n    }\n  );\n\n  return String(resp?.data?.choices?.[0]?.message?.content || '').trim();\n}\n\n// ===================== EXECUÃ‡ÃƒO (n8n) =====================\n\nconst secrets = $('Fetch Project Secrets').first().json || {};\n\nlet nextcloudBase = String(secrets.nextcloud_base_url || process.env.NEXTCLOUD_BASE_URL || '');\nwhile (nextcloudBase.endsWith('/')) nextcloudBase = nextcloudBase.slice(0, -1);\n\nconst nextcloudUser = String(\n  secrets.nextcloud_username || process.env.NEXTCLOUD_USERNAME || process.env.NEXTCLOUD_USER || ''\n);\nconst nextcloudPass = String(\n  secrets.nextcloud_password || process.env.NEXTCLOUD_PASSWORD || process.env.NEXTCLOUD_PASS || ''\n);\nconst mediaRoot = String(secrets.nextcloud_media_root || process.env.NEXTCLOUD_MEDIA_ROOT || 'SuperBotMedia');\n\nconst openrouterKey = String(secrets.openrouter_api_key || process.env.OPENROUTER_API_KEY || '');\n\nconst auth = { username: nextcloudUser, password: nextcloudPass };\nconst davBaseUrl = `${nextcloudBase}/remote.php/dav/files/${encodeURIComponent(nextcloudUser)}`;\n\nconst pageToken = String($('dados principais').item.json.access_token || '');\nconst projectId = String($('dados principais').item.json.project_id || 'unknown_project');\nconst channelType = 'instagram';\nconst conversationId = String($('dados principais').item.json.numero_conversa || 'unknown_conversation');\n\n// âœ… Processa sÃ³ 1 item\nconst it = $input.first();\n\nif (!nextcloudBase || !nextcloudUser || !nextcloudPass) {\n  return [\n    {\n      json: {\n        success: false,\n        attachment_index: it?.json?.attachment_index,\n        attachment_type: it?.json?.attachment_type,\n        original_url: it?.json?.attachment_url || '',\n        note: 'Missing Nextcloud credentials (global_secrets/project_secrets/env).',\n      },\n    },\n  ];\n}\n\nconst now = new Date();\nconst yyyy = String(now.getUTCFullYear());\nconst mm = String(now.getUTCMonth() + 1).padStart(2, '0');\nconst dd = String(now.getUTCDate()).padStart(2, '0');\n\nconst folderPath = `${mediaRoot}/${projectId}/${channelType}/${yyyy}/${mm}/${dd}/${conversationId}`;\nawait ensureDavFolders(davBaseUrl, folderPath, auth);\n\n// Guardrails para nÃ£o derrubar o Task Runner\nconst MAX_INPUT_BYTES = 15 * 1024 * 1024; // limite de download (audio/video)\nconst attachmentUrl = String(it?.json?.attachment_url || '');\nconst attachmentType = String(it?.json?.attachment_type || 'file');\nconst attachmentIndex = it?.json?.attachment_index ?? 0;\n\nlet note = '';\nlet transcription = '';\nlet analysis = '';\n\ntry {\n  if (!attachmentUrl) {\n    return [\n      {\n        json: {\n          success: false,\n          attachment_index: attachmentIndex,\n          attachment_type: attachmentType,\n          original_url: '',\n          note: 'Missing attachment URL.',\n        },\n      },\n    ];\n  }\n\n  const dl = await downloadAttachment(attachmentUrl, pageToken);\n  if (!dl.ok) {\n    return [\n      {\n        json: {\n          success: false,\n          attachment_index: attachmentIndex,\n          attachment_type: attachmentType,\n          original_url: attachmentUrl,\n          note: `Download failed (status ${dl.status}).`,\n        },\n      },\n    ];\n  }\n\n  const fileBuffer = dl.buffer;\n  const mimeType = dl.mimeType || 'application/octet-stream';\n\n  if (fileBuffer.length > MAX_INPUT_BYTES) {\n    return [\n      {\n        json: {\n          success: false,\n          attachment_index: attachmentIndex,\n          attachment_type: attachmentType,\n          original_url: attachmentUrl,\n          note: `Attachment too large (${fileBuffer.length} bytes).`,\n        },\n      },\n    ];\n  }\n\n  const ext = (inferExt(mimeType, attachmentUrl) || 'bin').replace(/[^a-z0-9]/gi, '').toLowerCase() || 'bin';\n  const suffix = suffixFor(attachmentType, ext, mimeType);\n\n  const iso = new Date().toISOString().replace(/[:.]/g, '-');\n  const filename = `${iso}-in-${String(attachmentIndex).padStart(2, '0')}.${ext}`;\n\n  // 1) Upload WebDAV\n  const davFileUrl = `${davBaseUrl}/${encodePath(folderPath)}/${encodeURIComponent(filename)}`;\n  await axios.put(davFileUrl, fileBuffer, {\n    auth,\n    headers: { 'Content-Type': mimeType },\n    timeout: 120000,\n    maxBodyLength: Infinity,\n    maxContentLength: Infinity,\n  });\n\n  // 2) Criar share link (Nextcloud OCS)\n  const shareApiUrl = `${nextcloudBase}/ocs/v2.php/apps/files_sharing/api/v1/shares?format=json`;\n  const shareResp = await axios.post(\n    shareApiUrl,\n    formEncode({ path: `/${folderPath}/${filename}`, shareType: 3, permissions: 1 }),\n    {\n      auth,\n      headers: {\n        'OCS-APIRequest': 'true',\n        'Content-Type': 'application/x-www-form-urlencoded',\n        Accept: 'application/json',\n      },\n      timeout: 120000,\n    }\n  );\n\n  const shareUrl = String(shareResp?.data?.ocs?.data?.url || '');\n  if (!shareUrl) {\n    throw new Error(`Nextcloud share API error: ${JSON.stringify(shareResp?.data)}`);\n  }\n\n  const downloadUrl = shareUrl.endsWith('/download') ? shareUrl : `${shareUrl}/download`;\n\n  // 3) Ãudio: transcrever igual aos nodes\n  if (attachmentType.toLowerCase() === 'audio') {\n    if (!openrouterKey) {\n      note = 'Audio received, but openrouter_api_key is missing (cannot transcribe automatically).';\n    } else {\n      try {\n        transcription = await transcribeOpenRouterLikeNodes(openrouterKey, fileBuffer, mimeType);\n      } catch (e) {\n        note = `Transcription failed: ${e?.response?.data ? JSON.stringify(e.response.data) : e.message}`;\n      }\n    }\n  }\n\n  return [\n    {\n      json: {\n        success: true,\n        attachment_index: attachmentIndex,\n        attachment_type: attachmentType,\n        mime_type: mimeType,\n        original_url: attachmentUrl,\n        nextcloud: {\n          path: `/${folderPath}/${filename}`,\n          share_url: shareUrl,\n          download_url: downloadUrl,\n        },\n        suffix,\n        transcription,\n        analysis,\n        note,\n      },\n    },\n  ];\n} catch (e) {\n  return [\n    {\n      json: {\n        success: false,\n        attachment_index: attachmentIndex,\n        attachment_type: attachmentType,\n        original_url: attachmentUrl,\n        note: e?.response?.data ? JSON.stringify(e.response.data) : e.message,\n      },\n    },\n  ];\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-352,416],"id":"5c3e8864-fb43-49ec-ad85-fc8877068948","name":"Process Attachments Batch (Nextcloud)"},{"parameters":{"jsCode":"const axios = require('axios');\n\nfunction encodePath(path) {\n  return path.split('/').map(encodeURIComponent).join('/');\n}\n\nasync function ensureDavFolders(davBaseUrl, folderPath, auth) {\n  const parts = folderPath.split('/').filter(Boolean);\n  let current = '';\n\n  for (const part of parts) {\n    current = current ? `${current}/${part}` : part;\n    const url = `${davBaseUrl}/${encodePath(current)}`;\n\n    try {\n      await axios.request({ method: 'MKCOL', url, auth });\n    } catch (error) {\n      const status = error?.response?.status;\n      if (status === 405 || status === 301 || status === 302 || status === 409) {\n        continue;\n      }\n      throw error;\n    }\n  }\n}\n\nfunction formEncode(obj) {\n  return Object.entries(obj)\n    .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(String(v))}`)\n    .join('&');\n}\n\nfunction inferExt(mimeType, url) {\n  const mt = (mimeType || '').toLowerCase();\n  if (mt.includes('jpeg')) return 'jpg';\n  if (mt.includes('png')) return 'png';\n  if (mt.includes('webp')) return 'webp';\n  if (mt.includes('gif')) return 'gif';\n  if (mt.includes('mp4')) return 'mp4';\n  if (mt.includes('mpeg')) return 'mp3';\n  if (mt.includes('mp3')) return 'mp3';\n  if (mt.includes('wav')) return 'wav';\n  if (mt.includes('ogg')) return 'ogg';\n  if (mt.includes('pdf')) return 'pdf';\n\n  try {\n    const clean = String(url || '').split('?')[0].split('#')[0];\n    const last = clean.split('/').pop() || '';\n    if (last.includes('.')) {\n      const ext = last.split('.').pop();\n      if (ext && ext.length <= 6) {\n        return ext.toLowerCase().replace(/[^a-z0-9]/g, '');\n      }\n    }\n  } catch (_) {}\n\n  return 'bin';\n}\n\nfunction suffixFor(type, ext) {\n  const t = (type || '').toLowerCase();\n  if (t === 'image') return '#image';\n  if (t === 'audio') return '#audio';\n  if (t === 'video') return '#video';\n  if (t === 'file' && (ext || '').toLowerCase() === 'pdf') return '#pdf';\n  return '#document';\n}\n\nconst secrets = $('Fetch Project Secrets').first().json || {};\n\nconst nextcloudBase = secrets.nextcloud_base_url || process.env.NEXTCLOUD_BASE_URL || '';\nconst nextcloudUser = secrets.nextcloud_username || process.env.NEXTCLOUD_USERNAME || process.env.NEXTCLOUD_USER || '';\nconst nextcloudPass = secrets.nextcloud_password || process.env.NEXTCLOUD_PASSWORD || process.env.NEXTCLOUD_PASS || '';\nconst mediaRoot = secrets.nextcloud_media_root || process.env.NEXTCLOUD_MEDIA_ROOT || 'SuperBotMedia';\n\nconst openrouterKey = secrets.openrouter_api_key || process.env.OPENROUTER_API_KEY || '';\n\nif (!nextcloudBase || !nextcloudUser || !nextcloudPass) {\n  throw new Error('Missing Nextcloud credentials (global_secrets/project_secrets/env)');\n}\n\nconst auth = { username: nextcloudUser, password: nextcloudPass };\n\nconst attachmentUrl = ($json.attachment_url || '').toString();\nconst attachmentType = ($json.attachment_type || '').toString();\n\nif (!attachmentUrl) {\n  return { json: { success: false, error: 'Missing attachment URL', attachment_type: attachmentType } };\n}\n\nconst pageToken = $('dados principais').item.json.access_token || '';\nconst baseHeaders = { 'User-Agent': 'Mozilla/5.0' };\n\nlet dl;\ntry {\n  dl = await axios.get(attachmentUrl, {\n    responseType: 'arraybuffer',\n    headers: pageToken ? { ...baseHeaders, Authorization: `Bearer ${pageToken}` } : baseHeaders,\n    maxRedirects: 5,\n    timeout: 60000,\n  });\n} catch (e) {\n  dl = await axios.get(attachmentUrl, {\n    responseType: 'arraybuffer',\n    headers: baseHeaders,\n    maxRedirects: 5,\n    timeout: 60000,\n  });\n}\n\nconst fileBuffer = Buffer.from(dl.data);\nconst mimeType = dl.headers?.['content-type'] || 'application/octet-stream';\n\nconst now = new Date();\nconst yyyy = String(now.getUTCFullYear());\nconst mm = String(now.getUTCMonth() + 1).padStart(2, '0');\nconst dd = String(now.getUTCDate()).padStart(2, '0');\nconst iso = now.toISOString().replace(/[:.]/g, '-');\n\nconst ext = (inferExt(mimeType, attachmentUrl) || 'bin').replace(/[^a-z0-9]/gi, '').toLowerCase() || 'bin';\n\nconst projectId = $('dados principais').item.json.project_id || 'unknown_project';\nconst channelType = 'instagram';\nconst conversationId = $('dados principais').item.json.numero_conversa || 'unknown_conversation';\n\nconst folderPath = `${mediaRoot}/${projectId}/${channelType}/${yyyy}/${mm}/${dd}/${conversationId}`;\nconst filename = `${iso}-in-${String($json.attachment_index || 0).padStart(2, '0')}.${ext}`;\n\nconst davBaseUrl = `${nextcloudBase}/remote.php/dav/files/${encodeURIComponent(nextcloudUser)}`;\nawait ensureDavFolders(davBaseUrl, folderPath, auth);\n\nconst davFileUrl = `${davBaseUrl}/${encodePath(folderPath)}/${encodeURIComponent(filename)}`;\nawait axios.put(davFileUrl, fileBuffer, {\n  auth,\n  headers: { 'Content-Type': mimeType },\n  timeout: 60000,\n});\n\nconst shareApiUrl = `${nextcloudBase}/ocs/v2.php/apps/files_sharing/api/v1/shares?format=json`;\nconst shareBody = formEncode({\n  path: `/${folderPath}/${filename}`,\n  shareType: 3,\n  permissions: 1,\n});\n\nconst shareResp = await axios.post(shareApiUrl, shareBody, {\n  auth,\n  headers: {\n    'OCS-APIRequest': 'true',\n    'Content-Type': 'application/x-www-form-urlencoded',\n    Accept: 'application/json',\n  },\n  timeout: 60000,\n});\n\nconst shareUrl = shareResp?.data?.ocs?.data?.url;\nif (!shareUrl) {\n  throw new Error(`Nextcloud share API error: ${JSON.stringify(shareResp?.data)}`);\n}\n\nconst downloadUrl = shareUrl.endsWith('/download') ? shareUrl : `${shareUrl}/download`;\nconst suffix = suffixFor(attachmentType, ext);\n\nlet transcription = '';\nlet analysis = '';\nlet note = '';\n\nif (openrouterKey) {\n  if (attachmentType === 'audio') {\n    const maxBytes = 8 * 1024 * 1024;\n    if (fileBuffer.length > maxBytes) {\n      note = `Audio too large to transcribe automatically (${fileBuffer.length} bytes).`;\n    } else {\n      try {\n        const base64 = fileBuffer.toString('base64');\n        const resp = await axios.post(\n          'https://openrouter.ai/api/v1/chat/completions',\n          {\n            model: 'google/gemini-2.5-flash-lite',\n            messages: [\n              {\n                role: 'user',\n                content: [\n                  {\n                    type: 'text',\n                    text: 'Transcreva este Ã¡udio de forma fiel (verbatim). Responda somente a transcriÃ§Ã£o.',\n                  },\n                  {\n                    type: 'image_url',\n                    image_url: { url: `data:${mimeType};base64,${base64}` },\n                  },\n                ],\n              },\n            ],\n          },\n          {\n            headers: {\n              Authorization: `Bearer ${openrouterKey}`,\n              'Content-Type': 'application/json',\n            },\n            timeout: 120000,\n          }\n        );\n\n        transcription = resp?.data?.choices?.[0]?.message?.content || '';\n      } catch (e) {\n        note = `Transcription failed: ${e?.response?.data ? JSON.stringify(e.response.data) : e.message}`;\n      }\n    }\n  } else if (attachmentType === 'image') {\n    try {\n      const resp = await axios.post(\n        'https://openrouter.ai/api/v1/chat/completions',\n        {\n          model: 'google/gemini-2.5-flash-lite',\n          messages: [\n            {\n              role: 'user',\n              content: [\n                {\n                  type: 'text',\n                  text: 'Descreva esta imagem e extraia qualquer texto relevante (OCR). Responda em pt-BR, em atÃ© 5 linhas.',\n                },\n                {\n                  type: 'image_url',\n                  image_url: { url: downloadUrl },\n                },\n              ],\n            },\n          ],\n        },\n        {\n          headers: {\n            Authorization: `Bearer ${openrouterKey}`,\n            'Content-Type': 'application/json',\n          },\n          timeout: 120000,\n        }\n      );\n\n      analysis = resp?.data?.choices?.[0]?.message?.content || '';\n    } catch (e) {\n      note = `Image analysis failed: ${e?.response?.data ? JSON.stringify(e.response.data) : e.message}`;\n    }\n  }\n}\n\nreturn {\n  json: {\n    success: true,\n    attachment_index: $json.attachment_index,\n    attachment_type: attachmentType,\n    mime_type: mimeType,\n    original_url: attachmentUrl,\n    nextcloud: {\n      path: `/${folderPath}/${filename}`,\n      share_url: shareUrl,\n      download_url: downloadUrl,\n    },\n    suffix,\n    transcription,\n    analysis,\n    note,\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-784,560],"id":"2255ef69-9fe9-436b-b6f7-51cd30b534f0","name":"Process Attachment (Nextcloud)","disabled":true},{"parameters":{"jsCode":"const text = ($('dados principais').item.json.conteudo_mensagem_text || '').toString().trim();\n\nconst lines = [];\nif (text) lines.push(text);\n\nlines.push('ðŸ“Ž MÃ­dias recebidas:');\n\nfor (const item of items) {\n  const downloadUrl = item.json.nextcloud?.download_url || '';\n  const suffix = item.json.suffix || '';\n  if (downloadUrl) {\n    lines.push(`${downloadUrl}${suffix}`);\n  }\n  if (item.json.transcription) {\n    lines.push(`TranscriÃ§Ã£o: ${String(item.json.transcription).trim()}`);\n  }\n  if (item.json.analysis) {\n    lines.push(`DescriÃ§Ã£o: ${String(item.json.analysis).trim()}`);\n  }\n}\n\nconst media = items.map((it) => ({\n  type: it.json.attachment_type,\n  url: (it.json.nextcloud?.download_url || '') + (it.json.suffix || ''),\n  download_url: it.json.nextcloud?.download_url || '',\n  share_url: it.json.nextcloud?.share_url || '',\n  path: it.json.nextcloud?.path || '',\n  original_url: it.json.original_url || '',\n  mime_type: it.json.mime_type || '',\n  transcription: it.json.transcription || '',\n  analysis: it.json.analysis || '',\n}));\n\nreturn {\n  json: {\n    final_user_message: lines.filter(Boolean).join('\\n'),\n    media,\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,480],"id":"d2b68a11-1b38-4fd0-879c-d61e257b0191","name":"Build Final User Message (Attachments)"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO public.conversation_events (\n  project_id,\n  channel_identifier,\n  channel_type,\n  conversation_id,\n  direction,\n  message_type,\n  text,\n  media,\n  raw_payload,\n  metadata\n)\nVALUES (\n  NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid,\n  '{{ $('dados principais').item.json.page_id }}',\n  'instagram',\n  '{{ $('dados principais').item.json.numero_conversa }}',\n  'in',\n  'media',\n  '{{ ($json.final_user_message || '').replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($json.media || []).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ JSON.stringify($('Messenger Trigger').item.json.body, (k, v) => (k === 'access_token' || k === 'openrouter_api_key' || k === 'elevenlabs_api_key' || k === 'nextcloud_password' || k === 'meta_master_token' || k === 'gemini_api_key') ? undefined : v).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ JSON.stringify({ timestamp: $('dados principais').item.json.Timestamp, has_attachments: $('dados principais').item.json.has_attachments }).replace(/'/g, \"''\") }}'::jsonb\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[160,528],"id":"7c8a1735-85e7-4327-8884-4ff5d19f4428","name":"Log Inbound Media Event (Postgres)","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"final-user-message-text","name":"final_user_message","value":"={{ $('dados principais').item.json.conteudo_mensagem_text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-64,0],"id":"1d119c2c-1d2f-42d3-9014-f18aa3d21a6b","name":"Final User Message (Text)"}],"connections":{"Messenger Trigger":{"main":[[{"node":"dados principais","type":"main","index":0}]]},"dados principais":{"main":[[{"node":"Fetch Project Secrets","type":"main","index":0},{"node":"Log Inbound Event (Postgres)","type":"main","index":0}]]},"Fetch Project Secrets":"[REDACTED]","Processar mensagem?":{"main":[[{"node":"Check #delete Command","type":"main","index":0}]]},"Tem texto?":{"main":[[{"node":"Final User Message (Text)","type":"main","index":0}],[{"node":"Responder apenas texto (Messenger)","type":"main","index":0}]]},"Check #delete Command":{"main":[[{"node":"reset-user-n8n_chat_histories","type":"main","index":0}],[{"node":"Gerenciar Usuario (Postgres)","type":"main","index":0}]]},"Gerenciar Usuario (Postgres)":{"main":[[{"node":"Tem anexos?","type":"main","index":0}]]},"Tem anexos?":{"main":[[{"node":"Prepare Attachments Items","type":"main","index":0}],[{"node":"Tem texto?","type":"main","index":0}]]},"Prepare Attachments Items":{"main":[[{"node":"Process Attachments Batch (Nextcloud)","type":"main","index":0}]]},"Process Attachments Batch (Nextcloud)":{"main":[[{"node":"Build Final User Message (Attachments)","type":"main","index":0}]]},"Process Attachment (Nextcloud)":{"main":[[]]},"Build Final User Message (Attachments)":{"main":[[{"node":"Log Inbound Media Event (Postgres)","type":"main","index":0},{"node":"Call Livia apenas o agente","type":"main","index":0}]]},"Final User Message (Text)":{"main":[[{"node":"Call Livia apenas o agente","type":"main","index":0}]]},"Call Livia apenas o agente":{"main":[[{"node":"Tratar resposta","type":"main","index":0}]]},"Tratar resposta":{"main":[[{"node":"Reposta da orquestra","type":"main","index":0}]]},"Reposta da orquestra":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Enviar mensagem (Messenger)":{"main":[[{"node":"Wait","type":"main","index":0},{"node":"Log Outbound Event (Postgres)","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}],[{"node":"Enviar mensagem (Messenger)","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"reset-user-n8n_chat_histories":{"main":[[{"node":"Reset User Data (SQL)","type":"main","index":0}]]},"Reset User Data (SQL)":{"main":[[{"node":"Send Reset Confirmation","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Messenger Trigger":[{"json":{"headers":{"host":"ai.superbot.digital","user-agent":"axios/1.12.0","content-length":"1094","accept":"application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"172.18.0.1","x-forwarded-host":"ai.superbot.digital","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"6ded5c78ff82","x-real-ip":"172.18.0.1"},"params":{},"query":{},"body":{"object":"instagram","entry":[{"time":1768519066192,"id":"17841479774657796","messaging":[{"sender":{"id":"2654113308288517"},"recipient":{"id":"17841479774657796"},"timestamp":1768519065108,"message":{"mid":"[REDACTED]","attachments":[{"type":"audio","payload":{"url":"https://lookaside.fbsbx.com/ig_messaging_cdn/?asset_id=3978410989123824&signature=[REDACTED]"}}]}}]}],"metadata":{"project_id":"1785d020-50f9-49a9-81d7-64927e3e6f96","channel_identifier":"17841479774657796","channel_type":"instagram","access_token":"[REDACTED]"}},"webhookUrl":"https://ai.superbot.digital/webhook/17841479774657796","executionMode":"production"},"pairedItem":{"item":0}}]},"versionId":"c4d06c52-9e99-4b1d-9e4c-7444f35c5299","activeVersionId":"c4d06c52-9e99-4b1d-9e4c-7444f35c5299","triggerCount":1,"shared":[{"updatedAt":"2026-01-15T16:14:26.594Z","createdAt":"2026-01-15T16:14:26.594Z","role":"workflow:owner","workflowId":"wnFeSldvIg2tODAu","projectId":"zyT6Lzq0Jawtq8wZ"}],"activeVersion":{"updatedAt":"2026-01-15T23:19:52.063Z","createdAt":"2026-01-15T23:19:52.063Z","versionId":"c4d06c52-9e99-4b1d-9e4c-7444f35c5299","workflowId":"wnFeSldvIg2tODAu","nodes":[{"parameters":{"httpMethod":"POST","path":"17841479774657796","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-2080,0],"id":"61f25f25-7333-4bef-ac72-ee6b7d2a285b","name":"Messenger Trigger","webhookId":"a7735139-15ae-4bee-ab65-d9d3d6e8c8be"},{"parameters":{"assignments":{"assignments":[{"id":"fe3f9231-7606-4073-91e4-898bf3922a76","name":"tipo_mensagem","value":"={{ $json.body.entry?.[0]?.messaging?.[0]?.message?.text ? 'text' : ($json.body.entry?.[0]?.messaging?.[0]?.message?.attachments?.[0]?.type || 'unknown') }}","type":"string"},{"id":"9da1fcfc-e5ea-4433-9933-595b24f0ba42","name":"numero_conversa","value":"={{ $json.body.entry?.[0]?.messaging?.[0]?.sender?.id || '' }}","type":"string"},{"id":"ebaa7566-ec95-46f0-87ec-ba1adac53613","name":"nome_cliente","value":"={{ '' }}","type":"string"},{"id":"a8d6f721-a227-45b0-92e7-b7848a3b9185","name":"Timestamp","value":"={{ new Date(($json.body.entry?.[0]?.messaging?.[0]?.timestamp || Date.now())).toISOString() }}","type":"string"},{"id":"b59136d5-cb83-4472-8649-d859c68844a6","name":"conteudo_mensagem_text","value":"={{ $json.body.entry?.[0]?.messaging?.[0]?.message?.text || '' }}","type":"string"},{"id":"c69fba37-a5aa-4904-8f7f-dd24372d6524","name":"is_echo","value":"={{ $json.body.entry?.[0]?.messaging?.[0]?.message?.is_echo === true }}","type":"boolean"},{"id":"2531bbcd-fb58-47bb-bfb6-b218c34832fc","name":"has_attachments","value":"={{ !!$json.body.entry?.[0]?.messaging?.[0]?.message?.attachments?.length }}","type":"boolean"},{"id":"0a7c0d55-a3d8-478c-b760-9a5a857b8c07","name":"should_process","value":"={{ !!$json.body.entry?.[0]?.messaging?.[0]?.message && $json.body.entry?.[0]?.messaging?.[0]?.message?.is_echo !== true }}","type":"boolean"},{"id":"1ea27905-eaf1-41b3-b598-eb2f9cf66f61","name":"should_process_text","value":"={{ !!$json.body.entry?.[0]?.messaging?.[0]?.message?.text }}","type":"boolean"},{"id":"3ed47908-a803-4656-89d7-acaddfb8fd63","name":"page_id","value":"={{ $json.body.metadata?.channel_identifier || $json.body.entry?.[0]?.id || '' }}","type":"string"},{"id":"f5b6f612-8025-479b-b49b-78741efbb87d","name":"project_id","value":"={{ $json.body.metadata?.project_id || '' }}","type":"string"},{"id":"94777bac-550b-43dd-96f3-83e3f25229a2","name":"access_token","value":"={{ $json.body.metadata?.access_token || '' }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1856,0],"id":"d85b611e-538d-484e-a921-30e5b768d25b","name":"dados principais"},{"parameters":{"operation":"executeQuery","query":"WITH project AS (\n  SELECT\n    openrouter_api_key,\n    elevenlabs_api_key,\n    gemini_api_key,\n    nextcloud_base_url,\n    nextcloud_username,\n    nextcloud_password,\n    nextcloud_media_root\n  FROM public.project_secrets\n  WHERE project_id = NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid\n  LIMIT 1\n),\n global AS (\n  SELECT\n    openrouter_api_key,\n    elevenlabs_api_key,\n    nextcloud_base_url,\n    nextcloud_username,\n    nextcloud_password\n  FROM public.global_secrets\n  ORDER BY created_at DESC\n  LIMIT 1\n)\nSELECT\n  COALESCE(project.openrouter_api_key, global.openrouter_api_key) AS openrouter_api_key,\n  COALESCE(project.elevenlabs_api_key, global.elevenlabs_api_key) AS elevenlabs_api_key,\n  project.gemini_api_key AS gemini_api_key,\n  COALESCE(project.nextcloud_base_url, global.nextcloud_base_url) AS nextcloud_base_url,\n  COALESCE(project.nextcloud_username, global.nextcloud_username) AS nextcloud_username,\n  COALESCE(project.nextcloud_password, global.nextcloud_password) AS nextcloud_password,\n  COALESCE(project.nextcloud_media_root, 'SuperBotMedia') AS nextcloud_media_root\nFROM (SELECT 1) AS base\nLEFT JOIN project ON true\nLEFT JOIN global ON true;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1632,96],"id":"47b606b7-177c-4a69-89e5-30edb08aeeed","name":"Fetch Project Secrets","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO public.conversation_events (\n  project_id,\n  channel_identifier,\n  channel_type,\n  conversation_id,\n  direction,\n  message_type,\n  text,\n  raw_payload,\n  metadata\n)\nVALUES (\n  NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid,\n  '{{ $('dados principais').item.json.page_id }}',\n  'instagram',\n  '{{ $('dados principais').item.json.numero_conversa }}',\n  'in',\n  '{{ $('dados principais').item.json.tipo_mensagem }}',\n  '{{ ($('dados principais').item.json.conteudo_mensagem_text || '').replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($('Messenger Trigger').item.json.body, (k, v) => (k === 'access_token' || k === 'openrouter_api_key' || k === 'elevenlabs_api_key' || k === 'nextcloud_password' || k === 'meta_master_token' || k === 'gemini_api_key') ? undefined : v).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ JSON.stringify({ timestamp: $('dados principais').item.json.Timestamp, is_echo: $('dados principais').item.json.is_echo, has_attachments: $('dados principais').item.json.has_attachments }).replace(/'/g, \"''\") }}'::jsonb\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-1632,-96],"id":"aa050d84-5e14-41f1-afdb-b84ead0ee359","name":"Log Inbound Event (Postgres)","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7f508402-93a3-4c26-bf39-ecd52613bcef","leftValue":"={{ $('dados principais').first().json.should_process }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1408,96],"id":"7ef5e9ff-a90e-40dc-81b7-4a41aab67dfa","name":"Processar mensagem?"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"520dad43-1dc3-49ce-8869-36775e5818d3","leftValue":"={{ $('dados principais').item.json.should_process_text }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-288,96],"id":"191440ad-d01b-42a4-bf5c-e5656fd119b6","name":"Tem texto?"},{"parameters":{"conditions":{"string":[{"value1":"={{ $('dados principais').item.json.conteudo_mensagem_text }}","operation":"contains","value2":"#delete"}]}},"type":"n8n-nodes-base.if","typeVersion":1,"position":[-1184,96],"id":"36c25dae-44e4-446e-926a-1bbada1b59ac","name":"Check #delete Command"},{"parameters":{"jsCode":"  const axios = require('axios');\n\n  const recipientId = $('dados principais').first().json.numero_conversa;\n  const token = $('dados principais').first().json.access_token;    \n\n  const messageText = 'âœ… Seus dados foram resetados com sucesso!\\n\\nVocÃª pode comeÃ§ar uma nova conversa do zero. Como posso te ajudar?';\n  // Usar me/messages (igual aos outros cÃ³digos que funcionam)      \n  const url = `https://graph.facebook.com/v21.0/me/messages`;       \n\n  const data = {\n    recipient: { id: recipientId },\n    message: { text: messageText }\n  };\n\n  try {\n    const resp = await axios.post(url, data, {\n      headers: {\n        Authorization: `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      },\n      timeout: 60000,\n    });\n\n    return {\n      json: {\n        success: true,\n        reset_complete: true,\n        sent: { text: messageText },\n        result: resp.data\n      }\n    };\n  } catch (error) {\n    return {\n      json: {\n        success: false,\n        error: error.response ? error.response.data : error.message,        errorStatus: error.response?.status,\n        errorDetails: error.response?.data?.error\n      }\n    };\n  }"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-512,-80],"id":"aa8bea23-2b70-4b48-ae51-d54436569df7","name":"Send Reset Confirmation"},{"parameters":{"operation":"executeQuery","query":"-- Gerenciar usuÃ¡rio multi-tenant com preservaÃ§Ã£o de metadados\nINSERT INTO public.users (\n  id, \n  project_id,\n  name, \n  metadata, \n  created_at, \n  updated_at\n)\nVALUES (\n  '{{ $('dados principais').item.json.numero_conversa }}',\n  NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid,\n  '{{ $('dados principais').item.json.nome_cliente }}',\n  '{}'::jsonb,\n  NOW(),\n  NOW()\n)\nON CONFLICT (id, project_id) DO UPDATE SET\n  name = EXCLUDED.name,\n  updated_at = NOW()\nRETURNING *;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-960,192],"id":"99880874-9b6d-44d8-9e3f-d1936cc581eb","name":"Gerenciar Usuario (Postgres)","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"workflowId":{"__rl":true,"value":"caAnMvnvVXE0mLvT","mode":"list","cachedResultUrl":"/workflow/caAnMvnvVXE0mLvT","cachedResultName":"Agente Livia"},"workflowInputs":{"mappingMode":"defineBelow","value":{"numero_conversa":"={{ $('dados principais').item.json.numero_conversa }}","final_user_message":"={{ $json.final_user_message }}","numero_conversa_firstItem":"={{ $('dados principais').first().json.numero_conversa }}","client_context":"={{ 'â“ [CLIENTE NÃƒO IDENTIFICADO VIA INSTAGRAM]\\nStatus: needs_cpf\\nInstruÃ§Ã£o: Tente solicitar o CPF para busca mais precisa.\\n' }}","birthday_alert":"={{ '' }}","customer_name_split":"={{ '' }}","id":"={{ $('Gerenciar Usuario (Postgres)').item.json.id }}","project_id":"={{ $('Gerenciar Usuario (Postgres)').item.json.project_id }}","channel_type":"={{ 'instagram' }}"},"matchingColumns":["numero_conversa","final_user_message","numero_conversa_firstItem","client_context","birthday_alert","customer_name_split","id","project_id","channel_type"],"schema":[{"id":"numero_conversa","displayName":"numero_conversa","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"final_user_message","displayName":"final_user_message","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"numero_conversa_firstItem","displayName":"numero_conversa_firstItem","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"client_context","displayName":"client_context","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"birthday_alert","displayName":"birthday_alert","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"customer_name_split","displayName":"customer_name_split","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"id","displayName":"id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"project_id","displayName":"project_id","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false},{"id":"channel_type","displayName":"channel_type","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[160,192],"id":"71b6c330-7c5b-4604-9883-12c0f6ba6484","name":"Call Livia apenas o agente"},{"parameters":{"jsCode":"const input = $input.first().json.output || '';\nconst output = input.replace(/\\*\\*(.*?)\\*\\*/g, '*$1*');\nreturn [{ json: { result: output } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[384,192],"id":"53dced79-03e1-4f7d-b813-7d11b7b1f9d3","name":"Tratar resposta"},{"parameters":{"assignments":{"assignments":[{"id":"bb70c647-df05-4b35-ba0d-be8ff4ba4335","name":"messages","value":"={{ ($json.result || '').split(\"\\n\\n\").filter(m => m.trim() !== '') }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[608,192],"id":"cf404649-37b1-4ced-82f4-67eee1577dbd","name":"Reposta da orquestra"},{"parameters":{"fieldToSplitOut":"messages","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[832,192],"id":"a24e43d0-e81a-4004-a8c1-ce7242e33e1a","name":"Split Out1"},{"parameters":{"jsCode":"  const axios = require('axios');\n\n  const recipientId = $('dados principais').first().json.numero_conversa;\n  const token = $('dados principais').first().json.access_token;    \n\n  let messageBody = ($json.messages || '').toString().trim();       \n  if (!messageBody) return { json: { success: true, skipped: true } \n};\n\n  // Extrair URL do Markdown: ![alt](url)\n  const markdownMatch = messageBody.match(/!\\[.*?\\]\\((.*?)\\)/);     \n  if (markdownMatch) messageBody = markdownMatch[1];\n\n  // Detectar tipo de mÃ­dia\n  let attachmentType = null;\n  let cleanUrl = messageBody;\n\n  const mediaUrlMatch = messageBody.match(/(https?:\\/\\/[^\\s]+#(?:image|video|audio))/i);\n  if (mediaUrlMatch) {\n    const full = mediaUrlMatch[1];\n    if (full.includes('#image')) {\n      attachmentType = 'image';\n      cleanUrl = full.replace(/#image/gi, '').trim();\n    } else if (full.includes('#video')) {\n      attachmentType = 'video';\n      cleanUrl = full.replace(/#video/gi, '').trim();\n    } else if (full.includes('#audio')) {\n      attachmentType = 'audio';\n      cleanUrl = full.replace(/#audio/gi, '').trim();\n    }\n  } else if (messageBody.includes('#image')) {\n    attachmentType = 'image';\n    cleanUrl = messageBody.replace(/#image/gi, '').trim();\n  }\n\n  const url = `https://graph.facebook.com/v21.0/me/messages`;       \n  const headers = {\n    Authorization: `Bearer ${token}`,\n    'Content-Type': 'application/json'\n  };\n\n  // ===== ENVIO DE IMAGEM POR URL =====\n  if (attachmentType === 'image' && cleanUrl) {\n    try {\n      const resp = await axios.post(\n        url,\n        {\n          recipient: { id: recipientId },\n          message: {\n            attachment: {\n              type: 'image',\n              payload: {\n                url: cleanUrl,\n                is_reusable: true\n              }\n            }\n          }\n        },\n        { headers, timeout: 60000 }\n      );\n\n      return {\n        json: {\n          success: true,\n          attachmentType: 'image',\n          sent: { type: 'image', url: cleanUrl },\n          result: resp.data,\n        }\n      };\n    } catch (e) {\n      // Fallback: envia como texto se der erro\n      try {\n        const fallbackResp = await axios.post(\n          url,\n          {\n            recipient: { id: recipientId },\n            message: { text: cleanUrl }\n          },\n          { headers, timeout: 60000 }\n        );\n\n        return {\n          json: {\n            success: false,\n            attachmentType: 'image',\n            fallback: true,\n            error: e?.response?.data || e.message,\n            sent: { text: cleanUrl },\n            result: fallbackResp.data,\n          }\n        };\n      } catch (fallbackError) {\n        return {\n          json: {\n            success: false,\n            attachmentType: 'image',\n            error: e?.response?.data || e.message,\n            fallbackError: fallbackError?.response?.data || fallbackError.message,\n            errorStatus: e?.response?.status,\n          }\n        };\n      }\n    }\n  }\n\n  // ===== ENVIO DE VÃDEO POR URL =====\n  if (attachmentType === 'video' && cleanUrl) {\n    try {\n      const resp = await axios.post(\n        url,\n        {\n          recipient: { id: recipientId },\n          message: {\n            attachment: {\n              type: 'video',\n              payload: {\n                url: cleanUrl,\n                is_reusable: true\n              }\n            }\n          }\n        },\n        { headers, timeout: 60000 }\n      );\n\n      return {\n        json: {\n          success: true,\n          attachmentType: 'video',\n          sent: { type: 'video', url: cleanUrl },\n          result: resp.data,\n        }\n      };\n    } catch (e) {\n      const fallbackResp = await axios.post(\n        url,\n        { recipient: { id: recipientId }, message: { text: cleanUrl \n} },\n        { headers, timeout: 60000 }\n      );\n\n      return {\n        json: {\n          success: false,\n          attachmentType: 'video',\n          fallback: true,\n          error: e?.response?.data || e.message,\n          sent: { text: cleanUrl },\n          result: fallbackResp.data,\n        }\n      };\n    }\n  }\n\n  // ===== ENVIO DE TEXTO =====\n  try {\n    const resp = await axios.post(\n      url,\n      {\n        recipient: { id: recipientId },\n        message: { text: messageBody }\n      },\n      { headers, timeout: 60000 }\n    );\n\n    return {\n      json: {\n        success: true,\n        attachmentType: 'text',\n        sent: { text: messageBody },\n        result: resp.data,\n      }\n    };\n  } catch (e) {\n    return {\n      json: {\n        success: false,\n        attachmentType: 'text',\n        error: e?.response?.data || e.message,\n        errorStatus: e?.response?.status,\n        errorDetails: e?.response?.data?.error\n      }\n    };\n  }"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1280,192],"id":"089393b8-fd75-4a6f-a123-30820ce579bc","name":"Enviar mensagem (Messenger)"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO public.conversation_events (\n  project_id,\n  channel_identifier,\n  channel_type,\n  conversation_id,\n  direction,\n  message_type,\n  text,\n  media,\n  raw_payload\n)\nVALUES (\n  NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid,\n  '{{ $('dados principais').item.json.page_id }}',\n  'instagram',\n  '{{ $('dados principais').item.json.numero_conversa }}',\n  'out',\n  '{{ $json.attachmentType || 'text' }}',\n  '{{ (($json.sent && $json.sent.text) ? $json.sent.text : '').replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($json.sent || {}).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ JSON.stringify($json, (k, v) => (k === 'access_token' || k === 'openrouter_api_key' || k === 'elevenlabs_api_key' || k === 'nextcloud_password' || k === 'meta_master_token' || k === 'gemini_api_key') ? undefined : v).replace(/'/g, \"''\") }}'::jsonb\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1504,144],"id":"154c97ab-67d9-43b9-b08a-c984e426f300","name":"Log Outbound Event (Postgres)","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"jsCode":"const axios = require('axios');\n\nconst recipientId = $('dados principais').first().json.numero_conversa;\nconst igId = $('dados principais').first().json.page_id || $('dados principais').first().json.channel_identifier || '';\nconst token = $('dados principais').first().json.access_token;\n\nconst messageText = 'N?o consegui processar essa mensagem no Instagram. Pode me dizer em texto como posso te ajudar?';\n\nif (!igId) {\n  return { json: { success: false, error: 'Missing Instagram id (dados principais.page_id)' } };\n}\n\nconst url = `https://graph.facebook.com/v21.0/${igId}/messages`;\n\ntry {\n  const resp = await axios.post(\n    url,\n    { recipient: { id: recipientId }, message: { text: messageText } },\n    { headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' }, timeout: 60000 }\n  );\n\n  return { json: { success: true, sent: { text: messageText }, result: resp.data } };\n} catch (error) {\n  return { json: { success: false, error: error.response ? error.response.data : error.message } };\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,208],"id":"1774e27d-acb4-42a8-b4c7-99134bcff372","name":"Responder apenas texto (Messenger)"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1056,192],"id":"9cf632e3-5100-4ed7-a743-048bf8f682b6","name":"Loop Over Items"},{"parameters":{"amount":1},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1504,368],"id":"5b68afef-6a41-45db-98ef-388571297aa9","name":"Wait","webhookId":"8b20e43c-d380-4615-a9a3-5de5015dcf0b"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1280,0],"id":"25474d05-6c49-4185-a1d9-9e62264729e4","name":"No Operation, do nothing"},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"deleteCommand":"delete","where":{"values":[{"column":"session_id","value":"={{ $('dados principais').item.json.project_id + ':instagram:' + $('dados principais').item.json.numero_conversa }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-960,-80],"id":"a8f99a98-d8a1-4540-bc48-1570e5403e13","name":"reset-user-n8n_chat_histories","alwaysOutputData":true,"credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"operation":"deleteTable","schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"users","mode":"list","cachedResultName":"users"},"deleteCommand":"delete","where":{"values":[{"column":"id","value":"={{ $('dados principais').item.json.numero_conversa }}"},{"column":"project_id","value":"={{ $('dados principais').item.json.project_id }}"}]},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-736,-80],"id":"b8422f26-0e2f-46b8-a216-9c5ad6e5c857","name":"Reset User Data (SQL)","alwaysOutputData":true,"credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"has_attachments_condition","leftValue":"={{ $('dados principais').item.json.has_attachments }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-736,192],"id":"293ce9a2-5827-4743-8fa1-9b6f752195b9","name":"Tem anexos?"},{"parameters":{"jsCode":"const attachments = $('Messenger Trigger').item.json.body.entry?.[0]?.messaging?.[0]?.message?.attachments || [];\nconst messageText = ($('dados principais').item.json.conteudo_mensagem_text || '').toString();\n\nif (!attachments.length) {\n  return [{ json: { attachment_index: 0, attachment_type: 'unknown', attachment_url: '', message_text: messageText } }];\n}\n\nreturn attachments.map((att, idx) => ({\n  json: {\n    attachment_index: idx,\n    attachment_type: att?.type || 'file',\n    attachment_url: att?.payload?.url || '',\n    message_text: messageText,\n    attachment: att,\n  }\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-544,320],"id":"efd55fc2-e1a3-4bc2-9d55-b6f340d03861","name":"Prepare Attachments Items"},{"parameters":{"jsCode":"/**\n * n8n Code node (Node.js)\n * - Baixa anexo (imagem/Ã¡udio/vÃ­deo/etc) com token da Meta se houver\n * - Salva no Nextcloud via WebDAV\n * - Cria share link (download)\n * - Se for Ã¡udio: transcreve IGUAL aos nodes (OpenRouter + google/gemini-2.5-flash-lite usando \"image_url\" data:audio/*;base64)\n */\n\nconst axios = require('axios');\nconst fs = require('fs');\n\nfunction encodePath(p) {\n  return p.split('/').map(encodeURIComponent).join('/');\n}\n\nasync function ensureDavFolders(davBaseUrl, folderPath, auth) {\n  const parts = folderPath.split('/').filter(Boolean);\n  let current = '';\n\n  for (const part of parts) {\n    current = current ? `${current}/${part}` : part;\n    const url = `${davBaseUrl}/${encodePath(current)}`;\n\n    try {\n      await axios.request({ method: 'MKCOL', url, auth, timeout: 120000 });\n    } catch (error) {\n      const status = error?.response?.status;\n      // 405: jÃ¡ existe; 301/302: redirect; 409: parent missing (pode acontecer em alguns davs)\n      if (status === 405 || status === 301 || status === 302 || status === 409) continue;\n      throw error;\n    }\n  }\n}\n\nfunction formEncode(obj) {\n  return Object.entries(obj)\n    .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(String(v))}`)\n    .join('&');\n}\n\nfunction inferExt(mimeType, url) {\n  const mt = (mimeType || '').toLowerCase();\n  if (mt.includes('jpeg')) return 'jpg';\n  if (mt.includes('png')) return 'png';\n  if (mt.includes('webp')) return 'webp';\n  if (mt.includes('gif')) return 'gif';\n  if (mt.includes('mp4')) return 'mp4';\n  if (mt.includes('mpeg')) return 'mp3';\n  if (mt.includes('mp3')) return 'mp3';\n  if (mt.includes('wav')) return 'wav';\n  if (mt.includes('ogg')) return 'ogg';\n  if (mt.includes('pdf')) return 'pdf';\n\n  try {\n    const clean = String(url || '').split('?')[0].split('#')[0];\n    const last = clean.split('/').pop() || '';\n    if (last.includes('.')) {\n      const ext = last.split('.').pop();\n      if (ext && ext.length <= 6) return ext.toLowerCase().replace(/[^a-z0-9]/g, '');\n    }\n  } catch (_) {}\n\n  return 'bin';\n}\n\nfunction suffixFor(type, ext, mimeType) {\n  const t = (type || '').toLowerCase();\n  const mt = (mimeType || '').toLowerCase();\n  if (t === 'audio') return '#audio';\n  if (t === 'image') return '#image';\n  if (t === 'video') return '#video';\n  if (t === 'file' && (ext || '').toLowerCase() === 'pdf') return '#pdf';\n  if (mt.startsWith('audio/')) return '#audio';\n  if (mt.startsWith('image/')) return '#image';\n  if (mt.startsWith('video/')) return '#video';\n  return '#document';\n}\n\nasync function downloadAttachment(url, pageToken) {\n  const attempt = async (headers) => {\n    const resp = await axios.get(url, {\n      responseType: 'arraybuffer',\n      headers,\n      timeout: 120000,\n      maxBodyLength: Infinity,\n      maxContentLength: Infinity,\n      validateStatus: () => true,\n      maxRedirects: 5,\n    });\n    return resp;\n  };\n\n  let resp = await attempt(pageToken ? { Authorization: `Bearer ${pageToken}` } : undefined);\n  if (resp.status < 200 || resp.status >= 300) resp = await attempt(undefined);\n\n  if (resp.status < 200 || resp.status >= 300) {\n    return { ok: false, status: resp.status, data: resp.data };\n  }\n\n  return {\n    ok: true,\n    status: resp.status,\n    buffer: Buffer.from(resp.data),\n    mimeType: resp.headers?.['content-type'] || '',\n  };\n}\n\n// === TranscriÃ§Ã£o igual aos seus nodes (OpenRouter + Gemini flash lite usando \"image_url\" com data:audio/*;base64) ===\nasync function transcribeOpenRouterLikeNodes(openrouterKey, fileBuffer, mimeType) {\n  const b64 = fileBuffer.toString('base64');\n\n  // No seu node vocÃª usa data:audio/mp3;base64, ...\n  // Aqui a gente usa o mime real quando for Ã¡udio, senÃ£o cai em audio/mpeg\n  const safeMime = (mimeType && mimeType.toLowerCase().startsWith('audio/')) ? mimeType : 'audio/mpeg';\n\n  const resp = await axios.post(\n    'https://openrouter.ai/api/v1/chat/completions',\n    {\n      model: 'google/gemini-2.5-flash-lite',\n      messages: [\n        {\n          role: 'user',\n          content: [\n            { type: 'text', text: 'faÃ§a a trancriÃ§Ã£o exata do audio.' },\n            {\n              type: 'image_url',\n              image_url: {\n                url: `data:${safeMime};base64,${b64}`,\n              },\n            },\n          ],\n        },\n      ],\n    },\n    {\n      headers: {\n        Authorization: `Bearer ${openrouterKey}`,\n        'Content-Type': 'application/json',\n      },\n      timeout: 180000,\n      maxBodyLength: Infinity,\n      maxContentLength: Infinity,\n    }\n  );\n\n  return String(resp?.data?.choices?.[0]?.message?.content || '').trim();\n}\n\n// ===================== EXECUÃ‡ÃƒO (n8n) =====================\n\nconst secrets = $('Fetch Project Secrets').first().json || {};\n\nlet nextcloudBase = String(secrets.nextcloud_base_url || process.env.NEXTCLOUD_BASE_URL || '');\nwhile (nextcloudBase.endsWith('/')) nextcloudBase = nextcloudBase.slice(0, -1);\n\nconst nextcloudUser = String(\n  secrets.nextcloud_username || process.env.NEXTCLOUD_USERNAME || process.env.NEXTCLOUD_USER || ''\n);\nconst nextcloudPass = String(\n  secrets.nextcloud_password || process.env.NEXTCLOUD_PASSWORD || process.env.NEXTCLOUD_PASS || ''\n);\nconst mediaRoot = String(secrets.nextcloud_media_root || process.env.NEXTCLOUD_MEDIA_ROOT || 'SuperBotMedia');\n\nconst openrouterKey = String(secrets.openrouter_api_key || process.env.OPENROUTER_API_KEY || '');\n\nconst auth = { username: nextcloudUser, password: nextcloudPass };\nconst davBaseUrl = `${nextcloudBase}/remote.php/dav/files/${encodeURIComponent(nextcloudUser)}`;\n\nconst pageToken = String($('dados principais').item.json.access_token || '');\nconst projectId = String($('dados principais').item.json.project_id || 'unknown_project');\nconst channelType = 'instagram';\nconst conversationId = String($('dados principais').item.json.numero_conversa || 'unknown_conversation');\n\n// âœ… Processa sÃ³ 1 item\nconst it = $input.first();\n\nif (!nextcloudBase || !nextcloudUser || !nextcloudPass) {\n  return [\n    {\n      json: {\n        success: false,\n        attachment_index: it?.json?.attachment_index,\n        attachment_type: it?.json?.attachment_type,\n        original_url: it?.json?.attachment_url || '',\n        note: 'Missing Nextcloud credentials (global_secrets/project_secrets/env).',\n      },\n    },\n  ];\n}\n\nconst now = new Date();\nconst yyyy = String(now.getUTCFullYear());\nconst mm = String(now.getUTCMonth() + 1).padStart(2, '0');\nconst dd = String(now.getUTCDate()).padStart(2, '0');\n\nconst folderPath = `${mediaRoot}/${projectId}/${channelType}/${yyyy}/${mm}/${dd}/${conversationId}`;\nawait ensureDavFolders(davBaseUrl, folderPath, auth);\n\n// Guardrails para nÃ£o derrubar o Task Runner\nconst MAX_INPUT_BYTES = 15 * 1024 * 1024; // limite de download (audio/video)\nconst attachmentUrl = String(it?.json?.attachment_url || '');\nconst attachmentType = String(it?.json?.attachment_type || 'file');\nconst attachmentIndex = it?.json?.attachment_index ?? 0;\n\nlet note = '';\nlet transcription = '';\nlet analysis = '';\n\ntry {\n  if (!attachmentUrl) {\n    return [\n      {\n        json: {\n          success: false,\n          attachment_index: attachmentIndex,\n          attachment_type: attachmentType,\n          original_url: '',\n          note: 'Missing attachment URL.',\n        },\n      },\n    ];\n  }\n\n  const dl = await downloadAttachment(attachmentUrl, pageToken);\n  if (!dl.ok) {\n    return [\n      {\n        json: {\n          success: false,\n          attachment_index: attachmentIndex,\n          attachment_type: attachmentType,\n          original_url: attachmentUrl,\n          note: `Download failed (status ${dl.status}).`,\n        },\n      },\n    ];\n  }\n\n  const fileBuffer = dl.buffer;\n  const mimeType = dl.mimeType || 'application/octet-stream';\n\n  if (fileBuffer.length > MAX_INPUT_BYTES) {\n    return [\n      {\n        json: {\n          success: false,\n          attachment_index: attachmentIndex,\n          attachment_type: attachmentType,\n          original_url: attachmentUrl,\n          note: `Attachment too large (${fileBuffer.length} bytes).`,\n        },\n      },\n    ];\n  }\n\n  const ext = (inferExt(mimeType, attachmentUrl) || 'bin').replace(/[^a-z0-9]/gi, '').toLowerCase() || 'bin';\n  const suffix = suffixFor(attachmentType, ext, mimeType);\n\n  const iso = new Date().toISOString().replace(/[:.]/g, '-');\n  const filename = `${iso}-in-${String(attachmentIndex).padStart(2, '0')}.${ext}`;\n\n  // 1) Upload WebDAV\n  const davFileUrl = `${davBaseUrl}/${encodePath(folderPath)}/${encodeURIComponent(filename)}`;\n  await axios.put(davFileUrl, fileBuffer, {\n    auth,\n    headers: { 'Content-Type': mimeType },\n    timeout: 120000,\n    maxBodyLength: Infinity,\n    maxContentLength: Infinity,\n  });\n\n  // 2) Criar share link (Nextcloud OCS)\n  const shareApiUrl = `${nextcloudBase}/ocs/v2.php/apps/files_sharing/api/v1/shares?format=json`;\n  const shareResp = await axios.post(\n    shareApiUrl,\n    formEncode({ path: `/${folderPath}/${filename}`, shareType: 3, permissions: 1 }),\n    {\n      auth,\n      headers: {\n        'OCS-APIRequest': 'true',\n        'Content-Type': 'application/x-www-form-urlencoded',\n        Accept: 'application/json',\n      },\n      timeout: 120000,\n    }\n  );\n\n  const shareUrl = String(shareResp?.data?.ocs?.data?.url || '');\n  if (!shareUrl) {\n    throw new Error(`Nextcloud share API error: ${JSON.stringify(shareResp?.data)}`);\n  }\n\n  const downloadUrl = shareUrl.endsWith('/download') ? shareUrl : `${shareUrl}/download`;\n\n  // 3) Ãudio: transcrever igual aos nodes\n  if (attachmentType.toLowerCase() === 'audio') {\n    if (!openrouterKey) {\n      note = 'Audio received, but openrouter_api_key is missing (cannot transcribe automatically).';\n    } else {\n      try {\n        transcription = await transcribeOpenRouterLikeNodes(openrouterKey, fileBuffer, mimeType);\n      } catch (e) {\n        note = `Transcription failed: ${e?.response?.data ? JSON.stringify(e.response.data) : e.message}`;\n      }\n    }\n  }\n\n  return [\n    {\n      json: {\n        success: true,\n        attachment_index: attachmentIndex,\n        attachment_type: attachmentType,\n        mime_type: mimeType,\n        original_url: attachmentUrl,\n        nextcloud: {\n          path: `/${folderPath}/${filename}`,\n          share_url: shareUrl,\n          download_url: downloadUrl,\n        },\n        suffix,\n        transcription,\n        analysis,\n        note,\n      },\n    },\n  ];\n} catch (e) {\n  return [\n    {\n      json: {\n        success: false,\n        attachment_index: attachmentIndex,\n        attachment_type: attachmentType,\n        original_url: attachmentUrl,\n        note: e?.response?.data ? JSON.stringify(e.response.data) : e.message,\n      },\n    },\n  ];\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-352,416],"id":"5c3e8864-fb43-49ec-ad85-fc8877068948","name":"Process Attachments Batch (Nextcloud)"},{"parameters":{"jsCode":"const axios = require('axios');\n\nfunction encodePath(path) {\n  return path.split('/').map(encodeURIComponent).join('/');\n}\n\nasync function ensureDavFolders(davBaseUrl, folderPath, auth) {\n  const parts = folderPath.split('/').filter(Boolean);\n  let current = '';\n\n  for (const part of parts) {\n    current = current ? `${current}/${part}` : part;\n    const url = `${davBaseUrl}/${encodePath(current)}`;\n\n    try {\n      await axios.request({ method: 'MKCOL', url, auth });\n    } catch (error) {\n      const status = error?.response?.status;\n      if (status === 405 || status === 301 || status === 302 || status === 409) {\n        continue;\n      }\n      throw error;\n    }\n  }\n}\n\nfunction formEncode(obj) {\n  return Object.entries(obj)\n    .map(([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(String(v))}`)\n    .join('&');\n}\n\nfunction inferExt(mimeType, url) {\n  const mt = (mimeType || '').toLowerCase();\n  if (mt.includes('jpeg')) return 'jpg';\n  if (mt.includes('png')) return 'png';\n  if (mt.includes('webp')) return 'webp';\n  if (mt.includes('gif')) return 'gif';\n  if (mt.includes('mp4')) return 'mp4';\n  if (mt.includes('mpeg')) return 'mp3';\n  if (mt.includes('mp3')) return 'mp3';\n  if (mt.includes('wav')) return 'wav';\n  if (mt.includes('ogg')) return 'ogg';\n  if (mt.includes('pdf')) return 'pdf';\n\n  try {\n    const clean = String(url || '').split('?')[0].split('#')[0];\n    const last = clean.split('/').pop() || '';\n    if (last.includes('.')) {\n      const ext = last.split('.').pop();\n      if (ext && ext.length <= 6) {\n        return ext.toLowerCase().replace(/[^a-z0-9]/g, '');\n      }\n    }\n  } catch (_) {}\n\n  return 'bin';\n}\n\nfunction suffixFor(type, ext) {\n  const t = (type || '').toLowerCase();\n  if (t === 'image') return '#image';\n  if (t === 'audio') return '#audio';\n  if (t === 'video') return '#video';\n  if (t === 'file' && (ext || '').toLowerCase() === 'pdf') return '#pdf';\n  return '#document';\n}\n\nconst secrets = $('Fetch Project Secrets').first().json || {};\n\nconst nextcloudBase = secrets.nextcloud_base_url || process.env.NEXTCLOUD_BASE_URL || '';\nconst nextcloudUser = secrets.nextcloud_username || process.env.NEXTCLOUD_USERNAME || process.env.NEXTCLOUD_USER || '';\nconst nextcloudPass = secrets.nextcloud_password || process.env.NEXTCLOUD_PASSWORD || process.env.NEXTCLOUD_PASS || '';\nconst mediaRoot = secrets.nextcloud_media_root || process.env.NEXTCLOUD_MEDIA_ROOT || 'SuperBotMedia';\n\nconst openrouterKey = secrets.openrouter_api_key || process.env.OPENROUTER_API_KEY || '';\n\nif (!nextcloudBase || !nextcloudUser || !nextcloudPass) {\n  throw new Error('Missing Nextcloud credentials (global_secrets/project_secrets/env)');\n}\n\nconst auth = { username: nextcloudUser, password: nextcloudPass };\n\nconst attachmentUrl = ($json.attachment_url || '').toString();\nconst attachmentType = ($json.attachment_type || '').toString();\n\nif (!attachmentUrl) {\n  return { json: { success: false, error: 'Missing attachment URL', attachment_type: attachmentType } };\n}\n\nconst pageToken = $('dados principais').item.json.access_token || '';\nconst baseHeaders = { 'User-Agent': 'Mozilla/5.0' };\n\nlet dl;\ntry {\n  dl = await axios.get(attachmentUrl, {\n    responseType: 'arraybuffer',\n    headers: pageToken ? { ...baseHeaders, Authorization: `Bearer ${pageToken}` } : baseHeaders,\n    maxRedirects: 5,\n    timeout: 60000,\n  });\n} catch (e) {\n  dl = await axios.get(attachmentUrl, {\n    responseType: 'arraybuffer',\n    headers: baseHeaders,\n    maxRedirects: 5,\n    timeout: 60000,\n  });\n}\n\nconst fileBuffer = Buffer.from(dl.data);\nconst mimeType = dl.headers?.['content-type'] || 'application/octet-stream';\n\nconst now = new Date();\nconst yyyy = String(now.getUTCFullYear());\nconst mm = String(now.getUTCMonth() + 1).padStart(2, '0');\nconst dd = String(now.getUTCDate()).padStart(2, '0');\nconst iso = now.toISOString().replace(/[:.]/g, '-');\n\nconst ext = (inferExt(mimeType, attachmentUrl) || 'bin').replace(/[^a-z0-9]/gi, '').toLowerCase() || 'bin';\n\nconst projectId = $('dados principais').item.json.project_id || 'unknown_project';\nconst channelType = 'instagram';\nconst conversationId = $('dados principais').item.json.numero_conversa || 'unknown_conversation';\n\nconst folderPath = `${mediaRoot}/${projectId}/${channelType}/${yyyy}/${mm}/${dd}/${conversationId}`;\nconst filename = `${iso}-in-${String($json.attachment_index || 0).padStart(2, '0')}.${ext}`;\n\nconst davBaseUrl = `${nextcloudBase}/remote.php/dav/files/${encodeURIComponent(nextcloudUser)}`;\nawait ensureDavFolders(davBaseUrl, folderPath, auth);\n\nconst davFileUrl = `${davBaseUrl}/${encodePath(folderPath)}/${encodeURIComponent(filename)}`;\nawait axios.put(davFileUrl, fileBuffer, {\n  auth,\n  headers: { 'Content-Type': mimeType },\n  timeout: 60000,\n});\n\nconst shareApiUrl = `${nextcloudBase}/ocs/v2.php/apps/files_sharing/api/v1/shares?format=json`;\nconst shareBody = formEncode({\n  path: `/${folderPath}/${filename}`,\n  shareType: 3,\n  permissions: 1,\n});\n\nconst shareResp = await axios.post(shareApiUrl, shareBody, {\n  auth,\n  headers: {\n    'OCS-APIRequest': 'true',\n    'Content-Type': 'application/x-www-form-urlencoded',\n    Accept: 'application/json',\n  },\n  timeout: 60000,\n});\n\nconst shareUrl = shareResp?.data?.ocs?.data?.url;\nif (!shareUrl) {\n  throw new Error(`Nextcloud share API error: ${JSON.stringify(shareResp?.data)}`);\n}\n\nconst downloadUrl = shareUrl.endsWith('/download') ? shareUrl : `${shareUrl}/download`;\nconst suffix = suffixFor(attachmentType, ext);\n\nlet transcription = '';\nlet analysis = '';\nlet note = '';\n\nif (openrouterKey) {\n  if (attachmentType === 'audio') {\n    const maxBytes = 8 * 1024 * 1024;\n    if (fileBuffer.length > maxBytes) {\n      note = `Audio too large to transcribe automatically (${fileBuffer.length} bytes).`;\n    } else {\n      try {\n        const base64 = fileBuffer.toString('base64');\n        const resp = await axios.post(\n          'https://openrouter.ai/api/v1/chat/completions',\n          {\n            model: 'google/gemini-2.5-flash-lite',\n            messages: [\n              {\n                role: 'user',\n                content: [\n                  {\n                    type: 'text',\n                    text: 'Transcreva este Ã¡udio de forma fiel (verbatim). Responda somente a transcriÃ§Ã£o.',\n                  },\n                  {\n                    type: 'image_url',\n                    image_url: { url: `data:${mimeType};base64,${base64}` },\n                  },\n                ],\n              },\n            ],\n          },\n          {\n            headers: {\n              Authorization: `Bearer ${openrouterKey}`,\n              'Content-Type': 'application/json',\n            },\n            timeout: 120000,\n          }\n        );\n\n        transcription = resp?.data?.choices?.[0]?.message?.content || '';\n      } catch (e) {\n        note = `Transcription failed: ${e?.response?.data ? JSON.stringify(e.response.data) : e.message}`;\n      }\n    }\n  } else if (attachmentType === 'image') {\n    try {\n      const resp = await axios.post(\n        'https://openrouter.ai/api/v1/chat/completions',\n        {\n          model: 'google/gemini-2.5-flash-lite',\n          messages: [\n            {\n              role: 'user',\n              content: [\n                {\n                  type: 'text',\n                  text: 'Descreva esta imagem e extraia qualquer texto relevante (OCR). Responda em pt-BR, em atÃ© 5 linhas.',\n                },\n                {\n                  type: 'image_url',\n                  image_url: { url: downloadUrl },\n                },\n              ],\n            },\n          ],\n        },\n        {\n          headers: {\n            Authorization: `Bearer ${openrouterKey}`,\n            'Content-Type': 'application/json',\n          },\n          timeout: 120000,\n        }\n      );\n\n      analysis = resp?.data?.choices?.[0]?.message?.content || '';\n    } catch (e) {\n      note = `Image analysis failed: ${e?.response?.data ? JSON.stringify(e.response.data) : e.message}`;\n    }\n  }\n}\n\nreturn {\n  json: {\n    success: true,\n    attachment_index: $json.attachment_index,\n    attachment_type: attachmentType,\n    mime_type: mimeType,\n    original_url: attachmentUrl,\n    nextcloud: {\n      path: `/${folderPath}/${filename}`,\n      share_url: shareUrl,\n      download_url: downloadUrl,\n    },\n    suffix,\n    transcription,\n    analysis,\n    note,\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-784,560],"id":"2255ef69-9fe9-436b-b6f7-51cd30b534f0","name":"Process Attachment (Nextcloud)","disabled":true},{"parameters":{"jsCode":"const text = ($('dados principais').item.json.conteudo_mensagem_text || '').toString().trim();\n\nconst lines = [];\nif (text) lines.push(text);\n\nlines.push('ðŸ“Ž MÃ­dias recebidas:');\n\nfor (const item of items) {\n  const downloadUrl = item.json.nextcloud?.download_url || '';\n  const suffix = item.json.suffix || '';\n  if (downloadUrl) {\n    lines.push(`${downloadUrl}${suffix}`);\n  }\n  if (item.json.transcription) {\n    lines.push(`TranscriÃ§Ã£o: ${String(item.json.transcription).trim()}`);\n  }\n  if (item.json.analysis) {\n    lines.push(`DescriÃ§Ã£o: ${String(item.json.analysis).trim()}`);\n  }\n}\n\nconst media = items.map((it) => ({\n  type: it.json.attachment_type,\n  url: (it.json.nextcloud?.download_url || '') + (it.json.suffix || ''),\n  download_url: it.json.nextcloud?.download_url || '',\n  share_url: it.json.nextcloud?.share_url || '',\n  path: it.json.nextcloud?.path || '',\n  original_url: it.json.original_url || '',\n  mime_type: it.json.mime_type || '',\n  transcription: it.json.transcription || '',\n  analysis: it.json.analysis || '',\n}));\n\nreturn {\n  json: {\n    final_user_message: lines.filter(Boolean).join('\\n'),\n    media,\n  }\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,480],"id":"d2b68a11-1b38-4fd0-879c-d61e257b0191","name":"Build Final User Message (Attachments)"},{"parameters":{"operation":"executeQuery","query":"INSERT INTO public.conversation_events (\n  project_id,\n  channel_identifier,\n  channel_type,\n  conversation_id,\n  direction,\n  message_type,\n  text,\n  media,\n  raw_payload,\n  metadata\n)\nVALUES (\n  NULLIF('{{ $('dados principais').item.json.project_id || '' }}', '')::uuid,\n  '{{ $('dados principais').item.json.page_id }}',\n  'instagram',\n  '{{ $('dados principais').item.json.numero_conversa }}',\n  'in',\n  'media',\n  '{{ ($json.final_user_message || '').replace(/'/g, \"''\") }}',\n  '{{ JSON.stringify($json.media || []).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ JSON.stringify($('Messenger Trigger').item.json.body, (k, v) => (k === 'access_token' || k === 'openrouter_api_key' || k === 'elevenlabs_api_key' || k === 'nextcloud_password' || k === 'meta_master_token' || k === 'gemini_api_key') ? undefined : v).replace(/'/g, \"''\") }}'::jsonb,\n  '{{ JSON.stringify({ timestamp: $('dados principais').item.json.Timestamp, has_attachments: $('dados principais').item.json.has_attachments }).replace(/'/g, \"''\") }}'::jsonb\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[160,528],"id":"7c8a1735-85e7-4327-8884-4ff5d19f4428","name":"Log Inbound Media Event (Postgres)","credentials":{"postgres":{"id":"XkopfZF03eoudUSD","name":"Postgres account"}}},{"parameters":{"assignments":{"assignments":[{"id":"final-user-message-text","name":"final_user_message","value":"={{ $('dados principais').item.json.conteudo_mensagem_text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-64,0],"id":"1d119c2c-1d2f-42d3-9014-f18aa3d21a6b","name":"Final User Message (Text)"}],"connections":{"Messenger Trigger":{"main":[[{"node":"dados principais","type":"main","index":0}]]},"dados principais":{"main":[[{"node":"Fetch Project Secrets","type":"main","index":0},{"node":"Log Inbound Event (Postgres)","type":"main","index":0}]]},"Fetch Project Secrets":"[REDACTED]","Processar mensagem?":{"main":[[{"node":"Check #delete Command","type":"main","index":0}]]},"Tem texto?":{"main":[[{"node":"Final User Message (Text)","type":"main","index":0}],[{"node":"Responder apenas texto (Messenger)","type":"main","index":0}]]},"Check #delete Command":{"main":[[{"node":"reset-user-n8n_chat_histories","type":"main","index":0}],[{"node":"Gerenciar Usuario (Postgres)","type":"main","index":0}]]},"Gerenciar Usuario (Postgres)":{"main":[[{"node":"Tem anexos?","type":"main","index":0}]]},"Tem anexos?":{"main":[[{"node":"Prepare Attachments Items","type":"main","index":0}],[{"node":"Tem texto?","type":"main","index":0}]]},"Prepare Attachments Items":{"main":[[{"node":"Process Attachments Batch (Nextcloud)","type":"main","index":0}]]},"Process Attachments Batch (Nextcloud)":{"main":[[{"node":"Build Final User Message (Attachments)","type":"main","index":0}]]},"Process Attachment (Nextcloud)":{"main":[[]]},"Build Final User Message (Attachments)":{"main":[[{"node":"Log Inbound Media Event (Postgres)","type":"main","index":0},{"node":"Call Livia apenas o agente","type":"main","index":0}]]},"Final User Message (Text)":{"main":[[{"node":"Call Livia apenas o agente","type":"main","index":0}]]},"Call Livia apenas o agente":{"main":[[{"node":"Tratar resposta","type":"main","index":0}]]},"Tratar resposta":{"main":[[{"node":"Reposta da orquestra","type":"main","index":0}]]},"Reposta da orquestra":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Enviar mensagem (Messenger)":{"main":[[{"node":"Wait","type":"main","index":0},{"node":"Log Outbound Event (Postgres)","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}],[{"node":"Enviar mensagem (Messenger)","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"reset-user-n8n_chat_histories":{"main":[[{"node":"Reset User Data (SQL)","type":"main","index":0}]]},"Reset User Data (SQL)":{"main":[[{"node":"Send Reset Confirmation","type":"main","index":0}]]}},"authors":"Emilio Ricci","name":null,"description":null},"tags":[]}