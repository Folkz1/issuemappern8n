{"createdAt":"2025-06-22T22:30:10.837Z","updatedAt":"2026-01-07T17:56:39.006Z","id":"JAHObMlBYzMKMPNb","name":"Notificaﾃｧﾃ｣o_erros_chegaram","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"=cronExpression","expression":"0 9 * * 1-5"}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-736,-32],"id":"046d00b1-be07-4c5f-a772-37c54c42ac4a","name":"Schedule Trigger"},{"parameters":{"options":{"fileName":"=relatorio_erros_{{ $now.toFormat('yyyy-MM-dd') }}.csv","headerRow":true}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[1872,0],"id":"34ede60f-1632-4842-9604-7684ab61c2fb","name":"Spreadsheet File"},{"parameters":{"fromEmail":"=\"Dot da Digital Pixel\" <dot@digitalpixel.com.br>","toEmail":"erik@digitalpixel.com.br","subject":"=笨 Monitoramento Ativo: {{ $('Bucar dominios com ero').first().json.total_erros_recebidos_hoje }} erros recebidos - IssueMapper","html":"={{ $('Criar email').item.json.html }}","options":{"appendAttribution":false,"attachments":"=data"}},"type":"n8n-nodes-base.emailSend","typeVersion":2.1,"position":[2192,112],"id":"f0c1ddc4-b187-45fe-99f2-35d673011920","name":"Send email1","webhookId":"4bc2649d-246a-4db8-a818-e13289eef831","executeOnce":true,"credentials":{"smtp":{"id":"shOWMvBSkf2d8rpR","name":"SMTP account"}}},{"parameters":{"operation":"executeQuery","query":"SELECT\n  COUNT(*) AS total_erros_recebidos_hoje\nFROM\n  public.eventos_erro\nWHERE\n  timestamp_erro_detectado >= date_trunc('day', now() AT TIME ZONE 'America/Sao_Paulo')\n  AND timestamp_erro_detectado < date_trunc('day', now() AT TIME ZONE 'America/Sao_Paulo') + interval '12 hours';\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-512,-16],"id":"e9082f81-312e-4f50-b436-6fa64f1471a0","name":"Bucar dominios com ero","alwaysOutputData":true,"credentials":{"postgres":{"id":"kdY0L5cBEpidbggQ","name":"Postgres issuemapper"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT\n  e.tipo_erro_site,\n  emp.dominio\nFROM\n  public.eventos_erro AS e\n  JOIN public.empresas AS emp ON e.empresa_id = emp.id\nWHERE\n  e.timestamp_erro_detectado >= date_trunc('day', now() AT TIME ZONE 'America/Sao_Paulo')\n  AND e.timestamp_erro_detectado < date_trunc('day', now() AT TIME ZONE 'America/Sao_Paulo') + interval '10 hours';","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-304,-16],"id":"7ae62c30-1cab-4c02-b9e1-ac12d4ed8700","name":"Quantidade de Domﾃｭnios por Cﾃｳdigo de Erro","alwaysOutputData":true,"credentials":{"postgres":{"id":"kdY0L5cBEpidbggQ","name":"Postgres issuemapper"}}},{"parameters":{"operation":"executeQuery","query":"SELECT\n  erros_prioritarios,\n  tdls_validos\nFROM\n  public.configuracoes_cadencia\nWHERE\n  ativo = true\nLIMIT 1;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[16,0],"id":"bb403a2e-9df8-4e6d-8db6-da197adeef2a","name":"Resumo de Domﾃｭnios Elegﾃｭveis para Prospecﾃｧﾃ｣o Hoje","alwaysOutputData":true,"executeOnce":true,"credentials":{"postgres":{"id":"kdY0L5cBEpidbggQ","name":"Postgres issuemapper"}}},{"parameters":{"jsCode":"// 洫 Pega as configuraﾃｧﾃｵes de erros e TLDs do nﾃｳ anterior.\nconst configsNode = $('Resumo de Domﾃｭnios Elegﾃｭveis para Prospecﾃｧﾃ｣o Hoje');\n\n// Valida se o nﾃｳ de configuraﾃｧﾃ｣o retornou dados\nif (!configsNode || !configsNode.first()) {\n    throw new Error(\"O nﾃｳ 'Resumo de Domﾃｭnios Elegﾃｭveis para Prospecﾃｧﾃ｣o Hoje' nﾃ｣o retornou dados. Verifique se a query estﾃ｡ correta e se hﾃ｡ uma configuraﾃｧﾃ｣o ativa.\");\n}\nconst configs = configsNode.first().json;\nconst errosPrioritarios = Array.isArray(configs.erros_prioritarios) ? configs.erros_prioritarios : JSON.parse(configs.erros_prioritarios || '[]');\nconst tdlsValidos = Array.isArray(configs.tdls_validos) ? configs.tdls_validos : JSON.parse(configs.tdls_validos || '[]');\n\n// 洫ｾ Pega a lista de todos os domﾃｭnios com erro detectados hoje.\n// CORREﾃﾃグ: Usar .all() que sempre retorna um array (mesmo que vazio), prevenindo o erro.\nconst todosOsErrosDeDominio = $('Quantidade de Domﾃｭnios por Cﾃｳdigo de Erro').all();\n\n// 洫ｪ Cria um Set para armazenar apenas os domﾃｭnios ﾃｺnicos que sﾃ｣o elegﾃｭveis.\n// Usar um Set evita contagens duplicadas automaticamente.\nconst dominiosElegiveisUnicos = new Set();\n\n// 沐 Itera sobre cada evento de erro/domﾃｭnio.\nfor (const itemWrapper of todosOsErrosDeDominio) {\n  const item = itemWrapper.json;\n\n  // Adiciona verificaﾃｧﾃ｣o para o caso de o item ou suas propriedades serem nulos\n  if (!item || !item.tipo_erro_site || !item.dominio) {\n    continue; // Pula para a prﾃｳxima iteraﾃｧﾃ｣o se os dados essenciais estiverem faltando\n  }\n\n  const codigoErro = parseInt(item.tipo_erro_site);\n  const dominio = item.dominio;\n\n  // 笨 Condiﾃｧﾃ｣o 1: O erro ﾃｩ prioritﾃ｡rio?\n  const erroEhPrioritario = errosPrioritarios.includes(codigoErro);\n\n  // 笨 Condiﾃｧﾃ｣o 2: O TLD do domﾃｭnio ﾃｩ vﾃ｡lido?\n  // A funﾃｧﾃ｣o .some() verifica se o domﾃｭnio termina com algum dos TLDs vﾃ｡lidos.\n  const tldEhValido = tdlsValidos.some(tld => dominio.endsWith('.' + tld));\n\n  // Se AMBAS as condiﾃｧﾃｵes forem verdadeiras, adiciona o domﾃｭnio ﾃ nossa lista de elegﾃｭveis.\n  if (erroEhPrioritario && tldEhValido) {\n    dominiosElegiveisUnicos.add(dominio);\n  }\n}\n\n// 沐 Retorna o nﾃｺmero total de domﾃｭnios ﾃｺnicos elegﾃｭveis.\nreturn {\n  total_dominios_validos: dominiosElegiveisUnicos.size\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[400,0],"id":"b36e5339-ebb3-4f69-b53d-6bee58c6291c","name":"dominios elegiveis","alwaysOutputData":true},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT ON (url_site_com_erro) *\nFROM public.eventos_erro\nWHERE timestamp_erro_detectado >= date_trunc('day', now() AT TIME ZONE 'America/Sao_Paulo')\n  AND timestamp_erro_detectado < date_trunc('day', now() AT TIME ZONE 'America/Sao_Paulo') + interval '10 hours'\n  AND tipo_erro_site IS NOT NULL\n  AND url_site_com_erro IS NOT NULL\nORDER BY url_site_com_erro, timestamp_erro_detectado DESC;\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1008,0],"id":"191f446b-2306-4bde-8cab-807e19aa5031","name":"Busca de eventos de erro do dia","alwaysOutputData":true,"credentials":{"postgres":{"id":"kdY0L5cBEpidbggQ","name":"Postgres issuemapper"}}},{"parameters":{"jsCode":"// Organizar CSV - versﾃ｣o robusta\n// Retorna uma lista de eventos (uma linha por evento) no formato n8n: [{ json: {...} }, ...]\n\n// ===== Helpers =====\nfunction tryParseDateToISO(val) {\n  if (!val && val !== 0) return \"\";\n  // Already ISO-ish string?\n  if (typeof val === \"string\" && /^\\d{4}-\\d{2}-\\d{2}T/.test(val)) return val;\n  try {\n    const d = new Date(val);\n    if (!isNaN(d.getTime())) return d.toISOString();\n  } catch (e) { /* ignore */ }\n  return String(val);\n}\n\nfunction extractFromNodeFallback(node) {\n  if (!node) return [];\n  // 1) Node.json could be an array (some nodes expose array directly)\n  if (Array.isArray(node.json)) return node.json;\n  // 2) Common shapes returned by DB nodes\n  if (Array.isArray(node.json?.data)) return node.json.data;\n  if (Array.isArray(node.json?.rows)) return node.json.rows;\n  if (Array.isArray(node.json?.results)) return node.json.results;\n  // 3) If node.json is a single object but actually contains an array under a key\n  for (const key of Object.keys(node.json || {})) {\n    if (Array.isArray(node.json[key])) return node.json[key];\n  }\n  // 4) If nothing else, return the single json object as array (fall back)\n  if (node.json && Object.keys(node.json).length > 0) return [node.json];\n  return [];\n}\n\n// ===== 1) Tentar pegar do input (preferencial) =====\nlet eventos = $input.all().map(i => i.json).filter(Boolean);\n\n// ===== 2) Se vazio, tentar extrair do node \"Busca de eventos de erro do dia\" =====\nif (!eventos || eventos.length === 0) {\n  try {\n    const nodoBusca = $node[\"Busca de eventos de erro do dia\"];\n    eventos = extractFromNodeFallback(nodoBusca);\n  } catch (err) {\n    eventos = [];\n  }\n}\n\n// ===== 3) Se ainda vazio, tentar outros nﾃｳs comuns (fallback extra) =====\nif ((!eventos || eventos.length === 0) && $node[\"Busca de eventos de erro do dia\"]) {\n  // jﾃ｡ tentou, mas vamos checar outras possﾃｭveis fontes que vocﾃｪ possa ter:\n  const tries = [\n    $node[\"Busca de eventos de erro do dia\"],\n    $node[\"Quantidade de Domﾃｭnios por Cﾃｳdigo de Erro\"],\n    $node[\"Aggregate\"]\n  ];\n  for (const n of tries) {\n    if (!n) continue;\n    const extracted = extractFromNodeFallback(n);\n    if (extracted && extracted.length > 0) {\n      eventos = extracted;\n      break;\n    }\n  }\n}\n\n// ===== 4) Mapear e normalizar =====\n// Colunas desejadas: url_site_com_erro, tipo_erro_site, data_criacao, nome_campanha\nconst linhas = (eventos || []).map(ev => {\n  // candidates: tenta vﾃ｡rios campos que podem existir em diferentes schemas\n  const urlCandidates = [ev.url_site_com_erro, ev.domain_url, ev.url, ev.site_url, ev.dominio];\n  const tipoCandidates = [ev.tipo_erro_site, ev.tipo_erro, ev.error_type, ev.codigo_erro];\n  const dateCandidates = [ev.data_criacao, ev.timestamp_erro_detectado, ev.created_at, ev.data, ev.timestamp];\n  const nomeCampanhaCandidates = [ev.nome_campanha, ev.campaign_name, ev.campanha];\n\n  const url_site_com_erro = urlCandidates.find(v => v !== undefined && v !== null && String(v).trim() !== \"\") ?? \"\";\n  const tipo_erro_site = tipoCandidates.find(v => v !== undefined && v !== null && String(v).trim() !== \"\") ?? \"\";\n  const rawDate = dateCandidates.find(v => v !== undefined && v !== null && String(v).trim() !== \"\") ?? \"\";\n  const data_criacao = tryParseDateToISO(rawDate);\n  const nome_campanha = nomeCampanhaCandidates.find(v => v !== undefined && v !== null) ?? \"\";\n\n  return {\n    url_site_com_erro: String(url_site_com_erro),\n    tipo_erro_site: String(tipo_erro_site),\n    data_criacao: String(data_criacao),\n    nome_campanha: String(nome_campanha)\n  };\n});\n\n// ===== 5) Retornar no formato n8n =====\nreturn linhas.map(l => ({ json: l }));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1456,0],"id":"e42c1ba3-9f93-479e-ad9b-c00d10e619d2","name":"Organizar CSV"},{"parameters":{"jsCode":"// Preparar Corpo Email - subject e html com resumo completo\n// Retorna: [{ json: { subject: \"...\", html: \"...\" } }]\n\n// ===== Helpers =====\n// Funﾃｧﾃ｣o segura para buscar dados de outros nﾃｳs, com um valor padrﾃ｣o em caso de falha.\nfunction safeGet(nodeName, path, fallback) {\n  try {\n    const node = $node[nodeName];\n    if (!node) return fallback;\n    const parts = path.split('.');\n    let v = node.json;\n    for (const p of parts) {\n      if (v === undefined || v === null) return fallback;\n      v = v[p];\n    }\n    return v ?? fallback;\n  } catch (e) {\n    return fallback;\n  }\n}\n\n// Funﾃｧﾃ｣o segura para buscar todos os itens de um nﾃｳ.\nfunction safeGetAll(nodeName) {\n    try {\n        const node = $('' + nodeName);\n        if (!node) return [];\n        return node.all();\n    } catch (e) {\n        return [];\n    }\n}\n\n\n// ===== Pegar valores dos nﾃｳs anteriores =====\nconst totalEventosHoje = safeGet(\"Bucar dominios com ero\", \"total_erros_recebidos_hoje\", 0);\nconst totalDominiosElegiveis = safeGet(\"dominios elegiveis\", \"total_dominios_validos\", 0);\n\n// Pega as configuraﾃｧﾃｵes (erros e TLDs)\n// CORREﾃﾃグ: Acessar o primeiro item (.first()) do resultado do nﾃｳ para obter o objeto de configuraﾃｧﾃｵes.\nconst configs = $('Resumo de Domﾃｭnios Elegﾃｭveis para Prospecﾃｧﾃ｣o Hoje').first()?.json || {};\nconst errosPrioritarios = Array.isArray(configs.erros_prioritarios) ? configs.erros_prioritarios : JSON.parse(configs.erros_prioritarios || '[]');\nconst tdlsValidos = Array.isArray(configs.tdls_validos) ? configs.tdls_validos : JSON.parse(configs.tdls_validos || '[]');\n\n// Pega a lista bruta de erros para calcular a distribuiﾃｧﾃ｣o\nconst todosOsErrosDeDominio = safeGetAll(\"Quantidade de Domﾃｭnios por Cﾃｳdigo de Erro\");\n\n\n// ===== Processar e Formatar Dados para o Relatﾃｳrio =====\n\n// Calcula a distribuiﾃｧﾃ｣o de domﾃｭnios ﾃｺnicos por cﾃｳdigo de erro\nconst contagemPorErro = {};\nfor (const itemWrapper of todosOsErrosDeDominio) {\n    const erro = itemWrapper.json;\n    if (erro && erro.tipo_erro_site) {\n        if (!contagemPorErro[erro.tipo_erro_site]) {\n            contagemPorErro[erro.tipo_erro_site] = new Set();\n        }\n        contagemPorErro[erro.tipo_erro_site].add(erro.dominio);\n    }\n}\n\nconst distribuicao = Object.entries(contagemPorErro)\n    .map(([tipo, dominiosSet]) => ({ tipo, qtd: dominiosSet.size }))\n    .sort((a, b) => b.qtd - a.qtd);\n\n\n// ===== Monta o conteﾃｺdo do email (subject e html) =====\nconst hoje = new Date().toLocaleDateString('pt-BR');\nconst subject = `笨 Monitoramento Ativo: ${totalEventosHoje} erros recebidos - IssueMapper`;\n\n// Formata a lista de distribuiﾃｧﾃ｣o para texto\nlet distribuicaoTexto = \"\";\nif (distribuicao.length > 0) {\n  for (const d of distribuicao) {\n    distribuicaoTexto += `- ${d.tipo}: ${d.qtd}\\n`;\n  }\n} else {\n  distribuicaoTexto = \"- Nenhum domﾃｭnio com erro detectado no perﾃｭodo.\\n\";\n}\n\n// Formata as configuraﾃｧﾃｵes para texto\nconst errosPrioritariosTexto = errosPrioritarios.length > 0 ? errosPrioritarios.join(\", \") : \"窶能";\nconst tdlsValidosTexto = tdlsValidos.length > 0 ? tdlsValidos.join(\", \") : \"窶能";\n\n\n// Monta o HTML com o template visual + bloco de resumo\nconst html = `<!DOCTYPE html>\n<html lang=\"pt-br\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <style>\n        body { font-family: sans-serif; line-height: 1.6; color: #333; }\n        .container { max-width: 700px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }\n        h1 { color: #5cb85c; margin-bottom: 6px; }\n        strong { font-size: 1.1em; }\n        .summary { background:#f8f8f8; border:1px solid #eee; padding:12px; border-radius:6px; margin-top:12px; white-space:pre-wrap; font-family: monospace; }\n        .meta { color: #666; font-size: 0.95em; margin-top: 8px; }\n        .footer { margin-top: 18px; color: #777; font-size: 0.9em; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>笨 Monitoramento Ativo - IssueMapper</h1>\n        <p>Olﾃ｡,</p>\n        <p>O fluxo de monitoramento foi executado em <strong>${hoje}</strong> e detectou atividade.</p>\n        <p>Foram recebidos <strong>${totalEventosHoje}</strong> novo(s) evento(s) de erro hoje, entre as 00:00 e as 10:00 da manhﾃ｣.</p>\n\n        <div class=\"summary\">\nRelatﾃｳrio diﾃ｡rio de erros - ${hoje}\n\nTotal de eventos recebidos: ${totalEventosHoje}\nTotal de domﾃｭnios elegﾃｭveis (erro prioritﾃ｡rio + TLD vﾃ｡lido): ${totalDominiosElegiveis}\n\n--- Configuraﾃｧﾃｵes Atuais ---\nErros prioritﾃ｡rios: ${errosPrioritariosTexto}\nTLDs vﾃ｡lidos: ${tdlsValidosTexto}\n\n--- Distribuiﾃｧﾃ｣o de Domﾃｭnios ﾃ嗜icos por Erro ---\n${distribuicaoTexto}\n        </div>\n\n        <div class=\"footer\">\n            <p><em>--<br>Este ﾃｩ um e-mail automﾃ｡tico.</em></p>\n        </div>\n    </div>\n</body>\n</html>`;\n\n// Retorna subject e html para o prﾃｳximo nﾃｳ\nreturn [{ json: { subject, html } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[656,0],"id":"5bb6659b-2a59-44c9-ba4b-93f87f042b0a","name":"Criar email","alwaysOutputData":true},{"parameters":{"fromEmail":"=\"Dot da Digital Pixel\" <dot@digitalpixel.com.br>","toEmail":"bdr@digitalpixel.com.br","subject":"=笨 Monitoramento Ativo: {{ $('Bucar dominios com ero').first().json.total_erros_recebidos_hoje }} erros recebidos - IssueMapper","html":"={{ $('Criar email').item.json.html }}","options":{"appendAttribution":false,"attachments":"=data"}},"type":"n8n-nodes-base.emailSend","typeVersion":2.1,"position":[2224,-336],"id":"74c5828d-5689-4dd4-98b3-beec77e94ef4","name":"Send email","webhookId":"4bc2649d-246a-4db8-a818-e13289eef831","executeOnce":true,"credentials":{"smtp":{"id":"shOWMvBSkf2d8rpR","name":"SMTP account"}}},{"parameters":{"fromEmail":"=\"Dot da Digital Pixel\" <dot@digitalpixel.com.br>","toEmail":"isis.santos@digitalpixel.com.br","subject":"=笨 Monitoramento Ativo: {{ $('Bucar dominios com ero').first().json.total_erros_recebidos_hoje }} erros recebidos - IssueMapper","html":"={{ $('Criar email').item.json.html }}","options":{"appendAttribution":false,"attachments":"=data"}},"type":"n8n-nodes-base.emailSend","typeVersion":2.1,"position":[2240,-80],"id":"7fca1e9e-669a-4925-8db1-41841d02dce2","name":"Send email2","webhookId":"4bc2649d-246a-4db8-a818-e13289eef831","executeOnce":true,"credentials":{"smtp":{"id":"shOWMvBSkf2d8rpR","name":"SMTP account"}}}],"connections":{"Schedule Trigger":{"main":[[{"node":"Bucar dominios com ero","type":"main","index":0}]]},"Spreadsheet File":{"main":[[{"node":"Send email2","type":"main","index":0},{"node":"Send email","type":"main","index":0},{"node":"Send email1","type":"main","index":0}]]},"Bucar dominios com ero":{"main":[[{"node":"Quantidade de Domﾃｭnios por Cﾃｳdigo de Erro","type":"main","index":0}]]},"Quantidade de Domﾃｭnios por Cﾃｳdigo de Erro":{"main":[[{"node":"Resumo de Domﾃｭnios Elegﾃｭveis para Prospecﾃｧﾃ｣o Hoje","type":"main","index":0}]]},"Resumo de Domﾃｭnios Elegﾃｭveis para Prospecﾃｧﾃ｣o Hoje":{"main":[[{"node":"dominios elegiveis","type":"main","index":0}]]},"dominios elegiveis":{"main":[[{"node":"Criar email","type":"main","index":0}]]},"Send email1":{"main":[[]]},"Busca de eventos de erro do dia":{"main":[[{"node":"Organizar CSV","type":"main","index":0}]]},"Organizar CSV":{"main":[[{"node":"Spreadsheet File","type":"main","index":0}]]},"Criar email":{"main":[[{"node":"Busca de eventos de erro do dia","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Schedule Trigger":[{"json":{"timestamp":"2026-01-07T09:00:00.024-03:00","Readable date":"January 7th 2026, 9:00:00 am","Readable time":"9:00:00 am","Day of week":"Wednesday","Year":"2026","Month":"January","Day of month":"07","Hour":"09","Minute":"00","Second":"00","Timezone":"America/Sao_Paulo (UTC-03:00)"}}]},"versionId":"b7793e10-2e5f-4e93-b83b-f0fa292f8043","triggerCount":1,"shared":[{"createdAt":"2025-06-22T22:30:10.837Z","updatedAt":"2025-06-22T22:30:10.837Z","role":"workflow:owner","workflowId":"JAHObMlBYzMKMPNb","projectId":"jzOAAIdP7BZ8Ke70"}],"tags":[{"createdAt":"2025-09-14T22:34:56.645Z","updatedAt":"2025-09-14T22:34:56.645Z","id":"hHX4poQqtegzPhSb","name":"issue"}]}